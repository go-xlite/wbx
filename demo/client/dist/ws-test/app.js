var B={MESSAGE:1,OPEN:2,ERROR:4,CLOSE:8},K={DISCONNECTED:1,CONNECTING:2,CONNECTED:4,ERROR:8},R={WORKER:1,DIRECT:4},x={ENABLED:1,BECAME_PRIMARY:2,BECAME_SECONDARY:4,TABS_UPDATED:8},$={ISOLATED:1,SHARED:2,SHARED_CONNECTION:4},f;class N{_;constructor(){this._=null}connect(){return this._.connect()}disconnect(){this._.disconnect()}send(j){return this._.send(j)}on(j,q){return this._.on(j,q),this}onCoordinationEvent(j,q){return this._.onCoordinationEvent(j,q),this}setPreferredMode(j){return this._.setPreferredMode(j)}clearPreferredMode(){this._.clearPreferredMode()}connectViaSharedWorker(){this._.connectViaSharedWorker()}connectDirectly(){this._.connectDirectly()}initConnectionCoordination(){return this._.initConnectionCoordination()}getKnownTabs(){return this._.getKnownTabs()}isPrimary(){return this._.isPrimary()}canSend(){return this._.connectionState===K.CONNECTED||this._.broadcastChannel&&this._.broadcastChannel!==null}isCoordinationEnabled(){return this._.broadcastChannel&&this._.broadcastChannel!==null}switchMode(j){let q=this._.connectionState===K.CONNECTED;if(this._.setPreferredMode(j)){if(q)setTimeout(()=>{this._.connect()},1000);return!0}return!1}resetMode(){let j=this._.connectionState===K.CONNECTED;if(this._.clearPreferredMode(),j)this._.disconnect(),setTimeout(()=>{this._.connect()},500)}getModeName(j){let q=j||this._.connectionMode;return{[R.WORKER]:"SharedWorker",[R.DIRECT]:"Direct"}[q]||"Unknown"}getDebugInfo(){return{connectionId:this._.connectionId,sessionId:this._.sessionId,connectionState:this._.connectionState,connectionMode:this._.connectionMode,modeName:this.getModeName(),isPrimary:this.isPrimary(),coordinationEnabled:this.isCoordinationEnabled(),canSend:this.canSend(),knownTabs:this._.getKnownTabs(),sessionData:this._.sessionData}}getCoordinationInfo(){return{enabled:this.isCoordinationEnabled(),isPrimary:this.isPrimary(),tabs:this._.getKnownTabs()}}get connectionState(){return this._.connectionState}get connectionMode(){return this._.connectionMode}get connectionId(){return this._.connectionId}get sessionId(){return this._.sessionId}get sessionStrategy(){return this._.sessionStrategy}get sessionData(){return this._.sessionData}setSessionValue(j,q){this._.setSessionValue(j,q)}getSessionValue(j){return this._.getSessionValue(j)}deleteSessionValue(j){this._.deleteSessionValue(j)}clearSession(){this._.clearSession()}get broadcastChannel(){return this._.broadcastChannel}}function A(){let j=window.location.pathname.split("/").filter((q)=>q);return j.length>0?"/"+j[0]:""}async function O(j){let q=A(),L=`${q}/ws/p/ws-manager-impl.js`;if(!f)f=await import(L);let X={...j,wsRoute:`${q}/ws/connect`,wsWorkerRoute:`${q}/ws/p/ws-shared-worker.js`,endpoint:j?.endpoint||`${q}/ws/connect`},V=new N;return V._=await f.createWebSocketManager(X),V}function y(){let j=window.location.pathname.split("/").filter((q)=>q);return j.length>0?"/"+j[0]:""}var l=y(),z=null,P=0,v=0,Z=null,Q=null,U=!1,D=sessionStorage.getItem("ws-session-strategy"),Y=D?parseInt(D,10):$.SHARED;function W(j){return j.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function F(j){let q=document.getElementById("wsStatus");if(q.className="ws-status "+(j===K.CONNECTED?"connected":j===K.CONNECTING?"connecting":"disconnected"),j===K.CONNECTED)q.textContent="\uD83D\uDFE2 Connected to WebSocket";else if(j===K.DISCONNECTED)q.textContent="\uD83D\uDD34 Disconnected";else if(j===K.CONNECTING)q.textContent="\uD83D\uDFE1 Connecting..."}function J(j,q="info"){let L=document.getElementById("messages"),X=document.createElement("div");X.className="message "+q;let V=new Date().toLocaleTimeString();X.innerHTML=`<strong>[${V}]</strong> ${W(j)}`,L.appendChild(X),L.scrollTop=L.scrollHeight}function G(){document.getElementById("sentCount").textContent=P,document.getElementById("receivedCount").textContent=v}function H(){if(Z){let j=Math.floor((Date.now()-Z)/1000),q=Math.floor(j/3600),L=Math.floor(j%3600/60),X=j%60;document.getElementById("uptime").textContent=`${q.toString().padStart(2,"0")}:${L.toString().padStart(2,"0")}:${X.toString().padStart(2,"0")}`}else document.getElementById("uptime").textContent="00:00:00"}function _(){if(!z){J("WebSocket manager not loaded yet","error");return}if(z.connectionState===K.CONNECTED){J("Already connected","error");return}F(K.CONNECTING),J("Connecting via WebSocket manager...","info"),J(`Connection mode: ${z.connectionMode||"auto-detect"}`,"info"),z.connect()}function c(){if(!z){J("WebSocket manager not loaded","error");return}if(z.connectionState!==K.CONNECTED){J("Not connected","error");return}J("Disconnecting...","info"),z.disconnect()}function k(){if(!z){J("WebSocket manager not loaded!","error");return}if(!z.canSend()){J("Not connected!","error");return}let j=document.getElementById("messageInput"),q=j.value.trim();if(!q){J("Cannot send empty message","error");return}z.send(q),P++,G(),J("Sent: "+q,"sent"),j.value=""}function E(){if(!z){J("WebSocket manager not loaded!","error");return}if(!z.canSend()){J("Not connected!","error");return}let j=JSON.stringify({type:"ping",timestamp:Date.now()});z.send(j),P++,G(),J("Sent PING","sent")}function w(){if(!z){J("WebSocket manager not loaded!","error");return}if(!z.canSend()){J("Not connected!","error");return}for(let j=1;j<=3;j++){let q=`Burst message ${j}/3`;z.send(q),P++}G(),J("Sent burst of 3 messages","sent")}function p(){document.getElementById("messages").innerHTML="",J("Message log cleared","info")}function I(j){if(!z){J("WebSocket manager not loaded","error");return}if(z.switchMode(j)){if(J(`Switched to ${z.getModeName(j)} mode`,"info"),document.querySelectorAll(".mode-btn").forEach((q)=>q.classList.remove("active")),document.querySelector(`[data-mode="${j}"]`).classList.add("active"),z.connectionState===K.CONNECTED||z.canSend())U=!0,J("Reconnecting with new mode...","info"),setTimeout(()=>{U=!1},1500)}else J("Failed to set connection mode","error")}function m(){if(!z){J("WebSocket manager not loaded","error");return}if(z.resetMode(),J("Cleared preferred mode (will auto-detect)","info"),document.querySelectorAll(".mode-btn").forEach((j)=>j.classList.remove("active")),z.connectionState===K.CONNECTED)U=!0,J("Reconnecting with auto-detect...","info"),setTimeout(()=>{U=!1},1500)}function b(j){Y=j,sessionStorage.setItem("ws-session-strategy",j);let q={[$.ISOLATED]:"Isolated",[$.SHARED]:"Shared"};J(`Session strategy will be: ${q[j]} (Direct mode only, takes effect on next reload)`,"info"),document.getElementById("currentStrategy").textContent=q[j],document.querySelectorAll(".session-btn").forEach((L)=>L.classList.remove("active")),document.querySelector(`[data-strategy="${j}"]`).classList.add("active")}function C(){if(!z)return;let j={[$.ISOLATED]:"Isolated",[$.SHARED]:"Shared",[$.SHARED_CONNECTION]:"Shared Connection (SharedWorker)"},q=z.sessionStrategy||Y;if(document.getElementById("currentStrategy").textContent=j[q]||`Unknown (${q})`,document.getElementById("currentSessionId").textContent=z.sessionId||"-",z.isCoordinationEnabled&&z.isCoordinationEnabled()){let L=z.getKnownTabs?z.getKnownTabs():[];document.getElementById("sessionTabCount").textContent=L.length}else document.getElementById("sessionTabCount").textContent="1 (no coordination)";h()}function h(){if(!z)return;let j=document.getElementById("sessionDataDisplay");j.textContent=JSON.stringify(z.sessionData||{},null,2)}function T(){if(!z){J("WebSocket manager not loaded","error");return}let j=document.getElementById("sessionKey").value.trim(),q=document.getElementById("sessionValue").value.trim();if(!j){J("Please enter a key","error");return}z.setSessionValue(j,q),J(`Set session[${j}] = "${q}"`,"info"),document.getElementById("sessionKey").value="",document.getElementById("sessionValue").value="",h()}function u(){if(!z){J("WebSocket manager not loaded","error");return}let j=document.getElementById("sessionKey").value.trim();if(!j){J("Please enter a key to get","error");return}let q=z.getSessionValue(j);if(q!==void 0)J(`session[${j}] = "${q}"`,"info"),document.getElementById("sessionValue").value=q;else J(`session[${j}] is not set`,"error")}function o(){if(!z){J("WebSocket manager not loaded","error");return}if(confirm("Clear all session data?"))z.clearSession(),J("Session data cleared","info"),h(),C()}async function i(){if(document.getElementById("connectBtn").addEventListener("click",_),document.getElementById("disconnectBtn").addEventListener("click",c),document.getElementById("sendBtn").addEventListener("click",k),document.getElementById("pingBtn").addEventListener("click",E),document.getElementById("burstBtn").addEventListener("click",w),document.querySelector('[data-mode="1"]').addEventListener("click",()=>I(1)),document.querySelector('[data-mode="4"]').addEventListener("click",()=>I(4)),document.querySelector('[data-strategy="1"]').addEventListener("click",()=>b($.ISOLATED)),document.querySelector('[data-strategy="2"]').addEventListener("click",()=>b($.SHARED)),document.getElementById("setSessionBtn").addEventListener("click",T),document.getElementById("getSessionBtn").addEventListener("click",u),document.getElementById("clearSessionBtn").addEventListener("click",o),document.querySelectorAll("button").forEach((q)=>{if(q.textContent.includes("Clear Log"))q.addEventListener("click",p);else if(q.textContent.includes("Auto-Detect"))q.addEventListener("click",m)}),document.getElementById("messageInput").addEventListener("keypress",function(q){if(q.key==="Enter")k()}),F(K.DISCONNECTED),G(),H(),J("Loading WebSocket manager...","info"),z=await O({debug:!0,endpoint:`${l}/ws/connect`,sessionStrategy:Y}),J("WebSocket manager loaded","info"),J(`Connection ID: ${z.connectionId}`,"info"),J(`Session ID: ${z.sessionId}`,"info"),C(),document.querySelector(`[data-strategy="${Y}"]`).classList.add("active"),z.connectionMode){let q=document.querySelector(`[data-mode="${z.connectionMode}"]`);if(q)q.classList.add("active");J(`Using preferred mode: ${z.getModeName()}`,"info")}if(z.connectionState===K.CONNECTED)F(K.CONNECTED),J("Already connected on load","info"),J(`Connection mode: ${z.getModeName()}`,"info"),Z=Date.now(),Q=setInterval(H,1000),document.getElementById("connectBtn").disabled=!0,document.getElementById("disconnectBtn").disabled=!1,document.getElementById("sendBtn").disabled=!1,document.getElementById("pingBtn").disabled=!1,document.getElementById("burstBtn").disabled=!1;if(z.on(B.OPEN,function(){F(K.CONNECTED),J("Connected successfully!","received"),J(`Connection mode: ${z.getModeName()}`,"info"),Z=Date.now(),Q=setInterval(H,1000),document.getElementById("connectBtn").disabled=!0,document.getElementById("disconnectBtn").disabled=!1,document.getElementById("sendBtn").disabled=!1,document.getElementById("pingBtn").disabled=!1,document.getElementById("burstBtn").disabled=!1}),z.on(B.MESSAGE,function(q){console.log("Raw message received:",JSON.stringify(q)),v++,G(),J("Received: "+q,"received")}),z.on(B.CLOSE,function(){if(U)return;if(F(K.DISCONNECTED),J("Connection closed","error"),Z=null,Q)clearInterval(Q),Q=null;H(),document.getElementById("connectBtn").disabled=!1,document.getElementById("disconnectBtn").disabled=!0,document.getElementById("sendBtn").disabled=!0,document.getElementById("pingBtn").disabled=!0,document.getElementById("burstBtn").disabled=!0}),z.on(B.ERROR,function(q){J("WebSocket error occurred","error")}),z.onCoordinationEvent)z.onCoordinationEvent(x.BECAME_PRIMARY,function(){J("This tab became the primary connection","info"),setTimeout(()=>{if(z.connectionState===K.CONNECTED){if(F(K.CONNECTED),Z=Z||Date.now(),!Q)Q=setInterval(H,1000);document.getElementById("connectBtn").disabled=!0,document.getElementById("disconnectBtn").disabled=!1,document.getElementById("sendBtn").disabled=!1,document.getElementById("pingBtn").disabled=!1,document.getElementById("burstBtn").disabled=!1}},100)}),z.onCoordinationEvent(x.BECAME_SECONDARY,function(){J("This tab is now secondary (connection maintained via SharedWorker)","info"),setTimeout(()=>{if(z.connectionState===K.CONNECTED){if(F(K.CONNECTED),Z=Z||Date.now(),!Q)Q=setInterval(H,1000);document.getElementById("connectBtn").disabled=!0,document.getElementById("disconnectBtn").disabled=!1,document.getElementById("sendBtn").disabled=!1,document.getElementById("pingBtn").disabled=!1,document.getElementById("burstBtn").disabled=!1}},100)}),z.onCoordinationEvent(x.TABS_UPDATED,function(q){C()}),z.onCoordinationEvent(x.ENABLED,function(){J("Tab coordination enabled","info"),setTimeout(()=>{if(z.connectionState===K.CONNECTED){if(F(K.CONNECTED),Z=Z||Date.now(),!Q)Q=setInterval(H,1000);document.getElementById("connectBtn").disabled=!0,document.getElementById("disconnectBtn").disabled=!1,document.getElementById("sendBtn").disabled=!1,document.getElementById("pingBtn").disabled=!1,document.getElementById("burstBtn").disabled=!1}},100)})}i();
