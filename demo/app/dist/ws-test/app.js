var h,H={MESSAGE:1,OPEN:2,ERROR:4,CLOSE:8},K={DISCONNECTED:1,CONNECTING:2,CONNECTED:4,ERROR:8},U={WORKER:1,DIRECT:4},P={ENABLED:1,BECAME_PRIMARY:2,BECAME_SECONDARY:4,TABS_UPDATED:8},Z={ISOLATED:1,SHARED:2,SHARED_CONNECTION:4};class R{constructor(){this._=null}connect(){return this._.connect()}disconnect(){this._.disconnect()}send(q){return this._.send(q)}on(q,F){return this._.on(q,F),this}onCoordinationEvent(q,F){return this._.onCoordinationEvent(q,F),this}setPreferredMode(q){return this._.setPreferredMode(q)}clearPreferredMode(){this._.clearPreferredMode()}connectViaSharedWorker(){this._.connectViaSharedWorker()}connectDirectly(){this._.connectDirectly()}initConnectionCoordination(){return this._.initConnectionCoordination()}getKnownTabs(){return this._.getKnownTabs()}isPrimary(){return this._.isPrimary()}canSend(){return this._.connectionState===4||this._.broadcastChannel&&this._.broadcastChannel!==null}isCoordinationEnabled(){return this._.broadcastChannel&&this._.broadcastChannel!==null}switchMode(q){let F=this._.connectionState===4;if(this._.setPreferredMode(q)){if(F)setTimeout(()=>{this._.connect()},1000);return!0}return!1}resetMode(){let q=this._.connectionState===4;if(this._.clearPreferredMode(),q)this._.disconnect(),setTimeout(()=>{this._.connect()},500)}getModeName(q){let F=q||this._.connectionMode;return{[U.WORKER]:"SharedWorker",[U.DIRECT]:"Direct"}[F]||"Unknown"}getDebugInfo(){return{connectionId:this._.connectionId,sessionId:this._.sessionId,connectionState:this._.connectionState,connectionMode:this._.connectionMode,modeName:this.getModeName(),isPrimary:this.isPrimary(),coordinationEnabled:this.isCoordinationEnabled(),canSend:this.canSend(),knownTabs:this._.getKnownTabs(),sessionData:this._.sessionData}}getCoordinationInfo(){return{enabled:this.isCoordinationEnabled(),isPrimary:this.isPrimary(),tabs:this._.getKnownTabs()}}get connectionState(){return this._.connectionState}get connectionMode(){return this._.connectionMode}get connectionId(){return this._.connectionId}get sessionId(){return this._.sessionId}setSessionValue(q,F){this._.setSessionValue(q,F)}getSessionValue(q){return this._.getSessionValue(q)}deleteSessionValue(q){this._.deleteSessionValue(q)}clearSession(){this._.clearSession()}get broadcastChannel(){return this._.broadcastChannel}}var A="/xt23/ws/p/ws-manager-impl.js";async function N(q){if(!h)h=await import(A);q.wsRoute="/xt23/ws/connect",q.wsWorkerRoute="/xt23/ws/p/ws-shared-worker.js",q.endpoint="/xt23/ws/connect";let F=new R;return F._=await h.createWebSocketManager(q),F}var z=null,Y=0,b=0,Q=null,L=null,B=!1,I=sessionStorage.getItem("ws-session-strategy"),G=I?parseInt(I,10):Z.SHARED;function l(q){return q.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function $(q){let F=document.getElementById("wsStatus");if(F.className="ws-status "+(q===K.CONNECTED?"connected":q===K.CONNECTING?"connecting":"disconnected"),q===K.CONNECTED)F.textContent="\uD83D\uDFE2 Connected to WebSocket";else if(q===K.DISCONNECTED)F.textContent="\uD83D\uDD34 Disconnected";else if(q===K.CONNECTING)F.textContent="\uD83D\uDFE1 Connecting..."}function J(q,F="info"){let X=document.getElementById("messages"),x=document.createElement("div");x.className="message "+F;let v=new Date().toLocaleTimeString();x.innerHTML=`<strong>[${v}]</strong> ${l(q)}`,X.appendChild(x),X.scrollTop=X.scrollHeight}function f(){document.getElementById("sentCount").textContent=Y,document.getElementById("receivedCount").textContent=b}function j(){if(Q){let q=Math.floor((Date.now()-Q)/1000),F=Math.floor(q/3600),X=Math.floor(q%3600/60),x=q%60;document.getElementById("uptime").textContent=`${F.toString().padStart(2,"0")}:${X.toString().padStart(2,"0")}:${x.toString().padStart(2,"0")}`}else document.getElementById("uptime").textContent="00:00:00"}function y(){if(!z){J("WebSocket manager not loaded yet","error");return}if(z.connectionState===K.CONNECTED){J("Already connected","error");return}$(K.CONNECTING),J("Connecting via WebSocket manager...","info"),J(`Connection mode: ${z.connectionMode||"auto-detect"}`,"info"),z.connect()}function W(){if(!z){J("WebSocket manager not loaded","error");return}if(window.wsManager.connectionState!==K.CONNECTED){J("Not connected","error");return}J("Disconnecting...","info"),window.wsManager.disconnect()}function k(){if(!z){J("WebSocket manager not loaded!","error");return}if(!z.canSend()){J("Not connected!","error");return}let q=document.getElementById("messageInput"),F=q.value.trim();if(!F){J("Cannot send empty message","error");return}z.send(F),Y++,f(),J("Sent: "+F,"sent"),q.value=""}function _(){if(!z){J("WebSocket manager not loaded!","error");return}if(!z.canSend()){J("Not connected!","error");return}let q=JSON.stringify({type:"ping",timestamp:Date.now()});z.send(q),Y++,f(),J("Sent PING","sent")}function c(){if(!z){J("WebSocket manager not loaded!","error");return}if(!z.canSend()){J("Not connected!","error");return}for(let q=1;q<=3;q++){let F=`Burst message ${q}/3`;z.send(F),Y++}f(),J("Sent burst of 3 messages","sent")}function w(){document.getElementById("messages").innerHTML="",J("Message log cleared","info")}function O(q){if(!z){J("WebSocket manager not loaded","error");return}if(z.switchMode(q)){if(J(`Switched to ${z.getModeName(q)} mode`,"info"),document.querySelectorAll(".mode-btn").forEach((F)=>F.classList.remove("active")),document.querySelector(`[data-mode="${q}"]`).classList.add("active"),z.connectionState===K.CONNECTED||z.canSend())B=!0,J("Reconnecting with new mode...","info"),setTimeout(()=>{B=!1},1500)}else J("Failed to set connection mode","error")}function E(){if(!z){J("WebSocket manager not loaded","error");return}if(z.resetMode(),J("Cleared preferred mode (will auto-detect)","info"),document.querySelectorAll(".mode-btn").forEach((q)=>q.classList.remove("active")),z.connectionState===K.CONNECTED)B=!0,J("Reconnecting with auto-detect...","info"),setTimeout(()=>{B=!1},1500)}function D(q){G=q,sessionStorage.setItem("ws-session-strategy",q);let F={[Z.ISOLATED]:"Isolated",[Z.SHARED]:"Shared"};J(`Session strategy will be: ${F[q]} (Direct mode only, takes effect on next reload)`,"info"),document.getElementById("currentStrategy").textContent=F[q],document.querySelectorAll(".session-btn").forEach((X)=>X.classList.remove("active")),document.querySelector(`[data-strategy="${q}"]`).classList.add("active")}function V(){if(!z)return;let q={[Z.ISOLATED]:"Isolated",[Z.SHARED]:"Shared",[Z.SHARED_CONNECTION]:"Shared Connection (SharedWorker)"},F=z.sessionStrategy||G;if(document.getElementById("currentStrategy").textContent=q[F]||`Unknown (${F})`,document.getElementById("currentSessionId").textContent=z.sessionId||"-",z.isCoordinationEnabled&&z.isCoordinationEnabled()){let X=z.getKnownTabs?z.getKnownTabs():[];document.getElementById("sessionTabCount").textContent=X.length}else document.getElementById("sessionTabCount").textContent="1 (no coordination)";C()}function C(){if(!z)return;let q=document.getElementById("sessionDataDisplay");q.textContent=JSON.stringify(z.sessionData||{},null,2)}function m(){if(!z){J("WebSocket manager not loaded","error");return}let q=document.getElementById("sessionKey").value.trim(),F=document.getElementById("sessionValue").value.trim();if(!q){J("Please enter a key","error");return}z.setSessionValue(q,F),J(`Set session[${q}] = "${F}"`,"info"),document.getElementById("sessionKey").value="",document.getElementById("sessionValue").value="",C()}function p(){if(!z){J("WebSocket manager not loaded","error");return}let q=document.getElementById("sessionKey").value.trim();if(!q){J("Please enter a key to get","error");return}let F=z.getSessionValue(q);if(F!==void 0)J(`session[${q}] = "${F}"`,"info"),document.getElementById("sessionValue").value=F;else J(`session[${q}] is not set`,"error")}function T(){if(!z){J("WebSocket manager not loaded","error");return}if(confirm("Clear all session data?"))z.clearSession(),J("Session data cleared","info"),C(),V()}async function u(){if(document.getElementById("connectBtn").addEventListener("click",y),document.getElementById("disconnectBtn").addEventListener("click",W),document.getElementById("sendBtn").addEventListener("click",k),document.getElementById("pingBtn").addEventListener("click",_),document.getElementById("burstBtn").addEventListener("click",c),document.querySelector('[data-mode="1"]').addEventListener("click",()=>O(1)),document.querySelector('[data-mode="4"]').addEventListener("click",()=>O(4)),document.querySelector('[data-strategy="1"]').addEventListener("click",()=>D(Z.ISOLATED)),document.querySelector('[data-strategy="2"]').addEventListener("click",()=>D(Z.SHARED)),document.getElementById("setSessionBtn").addEventListener("click",m),document.getElementById("getSessionBtn").addEventListener("click",p),document.getElementById("clearSessionBtn").addEventListener("click",T),document.querySelectorAll("button").forEach((F)=>{if(F.textContent.includes("Clear Log"))F.addEventListener("click",w);else if(F.textContent.includes("Auto-Detect"))F.addEventListener("click",E)}),document.getElementById("messageInput").addEventListener("keypress",function(F){if(F.key==="Enter")k()}),$(K.DISCONNECTED),f(),j(),J("Loading WebSocket manager...","info"),z=await N({debug:!0,endpoint:"/ws/connect",sessionStrategy:G}),J("WebSocket manager loaded","info"),J(`Connection ID: ${z.connectionId}`,"info"),J(`Session ID: ${z.sessionId}`,"info"),V(),document.querySelector(`[data-strategy="${G}"]`).classList.add("active"),z.connectionMode){let F=document.querySelector(`[data-mode="${z.connectionMode}"]`);if(F)F.classList.add("active");J(`Using preferred mode: ${z.getModeName()}`,"info")}if(z.connectionState===K.CONNECTED)$(K.CONNECTED),J("Already connected on load","info"),J(`Connection mode: ${z.getModeName()}`,"info"),Q=Date.now(),L=setInterval(j,1000),document.getElementById("connectBtn").disabled=!0,document.getElementById("disconnectBtn").disabled=!1,document.getElementById("sendBtn").disabled=!1,document.getElementById("pingBtn").disabled=!1,document.getElementById("burstBtn").disabled=!1;if(z.on(H.OPEN,function(){$(K.CONNECTED),J("Connected successfully!","received"),J(`Connection mode: ${z.getModeName()}`,"info"),Q=Date.now(),L=setInterval(j,1000),document.getElementById("connectBtn").disabled=!0,document.getElementById("disconnectBtn").disabled=!1,document.getElementById("sendBtn").disabled=!1,document.getElementById("pingBtn").disabled=!1,document.getElementById("burstBtn").disabled=!1}),z.on(H.MESSAGE,function(F){console.log("Raw message received:",JSON.stringify(F)),b++,f(),J("Received: "+F,"received")}),z.on(H.CLOSE,function(){if(B)return;if(!z.isCoordinationEnabled()||z.connectionMode===U.DIRECT){if($(K.DISCONNECTED),J("Connection closed","error"),Q=null,L)clearInterval(L),L=null;j(),document.getElementById("connectBtn").disabled=!1,document.getElementById("disconnectBtn").disabled=!0,document.getElementById("sendBtn").disabled=!0,document.getElementById("pingBtn").disabled=!0,document.getElementById("burstBtn").disabled=!0}}),z.on(H.ERROR,function(F){J("WebSocket error occurred","error"),console.error("WebSocket error:",F)}),z.onCoordinationEvent)z.onCoordinationEvent(P.BECAME_PRIMARY,function(){J("This tab became the primary connection","info"),setTimeout(()=>{if(z.connectionState===K.CONNECTED){if($(K.CONNECTED),Q=Q||Date.now(),!L)L=setInterval(j,1000);document.getElementById("connectBtn").disabled=!0,document.getElementById("disconnectBtn").disabled=!1,document.getElementById("sendBtn").disabled=!1,document.getElementById("pingBtn").disabled=!1,document.getElementById("burstBtn").disabled=!1}},100)}),z.onCoordinationEvent(P.BECAME_SECONDARY,function(){J("This tab is now secondary (connection maintained via SharedWorker)","info"),setTimeout(()=>{if(z.connectionState===K.CONNECTED){if($(K.CONNECTED),Q=Q||Date.now(),!L)L=setInterval(j,1000);document.getElementById("connectBtn").disabled=!0,document.getElementById("disconnectBtn").disabled=!1,document.getElementById("sendBtn").disabled=!1,document.getElementById("pingBtn").disabled=!1,document.getElementById("burstBtn").disabled=!1}},100)}),z.onCoordinationEvent(P.TABS_UPDATED,function(F){console.log("Known tabs:",F),V()}),z.onCoordinationEvent(P.ENABLED,function(){J("Tab coordination enabled","info"),setTimeout(()=>{if(z.connectionState===K.CONNECTED){if($(K.CONNECTED),Q=Q||Date.now(),!L)L=setInterval(j,1000);document.getElementById("connectBtn").disabled=!0,document.getElementById("disconnectBtn").disabled=!1,document.getElementById("sendBtn").disabled=!1,document.getElementById("pingBtn").disabled=!1,document.getElementById("burstBtn").disabled=!1}},100)})}u();
