class B{#q=!1;#F=0;#U;#j=null;#A=null;#D;#K=null;#B=null;#O=null;#Q=null;#R=null;#V;#W;#X;#Y;#Z;#$;#z;constructor(j,q={}){this.#U=j,this.#z=this.#M(),this.#D="sse-coord-"+btoa(j).replace(/=/g,""),this.ops={reconnect:q.reconnect??!0,reconnectInterval:q.reconnectInterval??5000,heartbeatInterval:q.heartbeatInterval??2000,electionTimeout:q.electionTimeout??500,failoverCheckInterval:q.failoverCheckInterval??1e4},this.#V=[],this.#W=[],this.#X=[],this.#Y=[],this.#Z=[],this.#$=[]}#M(){return Date.now().toString()+"-"+Math.random().toString(36).substr(2,9)}connect(){if(this.#F!==0){console.warn("[SSEManager] Already connected or connecting");return}if(this.#j)this.#j.close(),this.#j=null;this.#F=1,this.#H()}disconnect(){if(this.ops.reconnect=!1,this.#F=0,this.#p(),this.#j)this.#j.onopen=null,this.#j.onmessage=null,this.#j.onerror=null,this.#j.close(),this.#j=null;if(this.#A)this.#A.postMessage({type:105,instanceId:this.#z}),this.#A.close(),this.#A=null;this.#q=!1,this.#J(3)}#H(){try{this.#A=new BroadcastChannel(this.#D),this.#A.onmessage=(j)=>{this.#f(j.data)},this.#A.postMessage({type:101,instanceId:this.#z}),this.#B=setTimeout(()=>{this.#x()},this.ops.electionTimeout)}catch(j){console.warn("[SSEManager] BroadcastChannel not supported, connecting directly"),this.#G()}}#f(j){switch(j.type){case 101:if(this.#q)this.#A.postMessage({type:102,instanceId:this.#z});break;case 102:if(!this.#q&&j.instanceId!==this.#z)clearTimeout(this.#B),this.#N();break;case 103:if(!this.#q&&j.instanceId!==this.#z)this.#R=Date.now();break;case 104:if(!this.#q)this.#J(0,j.message);break;case 105:if(!this.#q&&j.instanceId!==this.#z)clearTimeout(this.#B),this.#B=setTimeout(()=>this.#x(),100);break;case 106:if(j.instanceId!==this.#z)if(j.instanceId<this.#z)if(this.#q)this.#L();else clearTimeout(this.#B);else this.#A.postMessage({type:107,instanceId:this.#z});break;case 107:if(j.instanceId<this.#z&&j.instanceId!==this.#z){if(clearTimeout(this.#B),this.#q)this.#L()}break;case 100:if(j.instanceId!==this.#z)if(this.#q){if(j.instanceId<this.#z)this.#L()}else this.#R=Date.now();break}}#x(){if(!this.#A){this.#G();return}this.#A.postMessage({type:106,instanceId:this.#z}),clearTimeout(this.#B),this.#B=setTimeout(()=>{if(!this.#q)this.#G()},500)}#G(){if(this.#q)return;if(this.#q=!0,this.#F=2,this.#A)this.#A.postMessage({type:100,instanceId:this.#z});this.#w(),this.#K=setInterval(()=>{if(this.#A&&this.#q)this.#A.postMessage({type:103,instanceId:this.#z})},this.ops.heartbeatInterval),this.#J(4)}#N(){if(!this.#q&&this.#j)return;this.#q=!1,this.#F=2,this.#R=Date.now(),this.#Q=setInterval(()=>{if(Date.now()-(this.#R||0)>this.ops.failoverCheckInterval)this.#x()},this.ops.failoverCheckInterval),this.#J(5),this.#J(1)}#L(){if(this.#j)this.#j.close(),this.#j=null;if(this.#K)clearInterval(this.#K),this.#K=null;this.#q=!1,this.#N()}#w(){if(this.#j)this.#j.onopen=null,this.#j.onmessage=null,this.#j.onerror=null,this.#j.close(),this.#j=null;this.#j=new EventSource(this.#U),this.#j.onopen=()=>{this.#F=2,this.#J(1)},this.#j.onmessage=(j)=>{if(this.#J(0,j.data),this.#q&&this.#A)this.#A.postMessage({type:104,message:j.data,instanceId:this.#z})},this.#j.onerror=(j)=>{if(this.#J(2,j),this.#j.readyState===EventSource.CLOSED)this.#E()}}#E(){if(this.#F=0,this.#j)this.#j.close(),this.#j=null;if(this.#J(3),this.ops.reconnect&&this.#q)this.#O=setTimeout(()=>{if(this.#q)this.#w()},this.ops.reconnectInterval)}#p(){if(this.#K)clearInterval(this.#K),this.#K=null;if(this.#B)clearTimeout(this.#B),this.#B=null;if(this.#O)clearTimeout(this.#O),this.#O=null;if(this.#Q)clearInterval(this.#Q),this.#Q=null}on(j,q){switch(j){case 0:this.#V.push(q);break;case 1:this.#W.push(q);break;case 2:this.#X.push(q);break;case 3:this.#Y.push(q);break;case 4:this.#Z.push(q);break;case 5:this.#$.push(q);break}}#J(j,q){let z;switch(j){case 0:z=this.#V;break;case 1:z=this.#W;break;case 2:z=this.#X;break;case 3:z=this.#Y;break;case 4:z=this.#Z;break;case 5:z=this.#$;break}if(z)z.forEach((A)=>A(q))}isPrimaryConnection(){return this.#q}getConnectionState(){return this.#F}getState(){let j={};return j.connectionState=this.#F,j.isPrimary=this.#q,j.instanceId=this.#z,j.url=this.#U,j}}export{B as SSEManager};
