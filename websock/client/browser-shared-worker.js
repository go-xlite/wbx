var H=new Set,j=null,L=null,J=0,Q=null,X=10;self.onconnect=function(w){let z=w.ports[0];if(H.add(z),z.start(),z.addEventListener("message",function(E){Y(E.data,z)}),z.addEventListener("close",function(){if(H.delete(z),H.size===0&&j)j.close(),j=null,clearTimeout(Q)}),j&&j.readyState===WebSocket.OPEN)z.postMessage({type:8,connectionId:L})};function Y(w,z){switch(w.type){case 1:if(!j||j.readyState!==WebSocket.OPEN)U(w.connectionId);break;case 2:if(j)j.close(),j=null;break;case 4:if(j&&j.readyState===WebSocket.OPEN)j.send(w.data);else z.postMessage({type:64,error:"Socket not connected"});break;case 128:if(!j||j.readyState!==WebSocket.OPEN)U(w.connectionId);break;case 256:if(console.log("[SharedWorker] Global shutdown requested"),j)j.close(),j=null;F({type:16,reason:"global_shutdown"}),H.forEach((E)=>{try{E.close()}catch(N){console.error("[SharedWorker] Error closing port",N)}}),H.clear();try{self.close()}catch(E){console.error("[SharedWorker] Error self-terminating",E)}break}}function U(w){if(j&&(j.readyState===WebSocket.CONNECTING||j.readyState===WebSocket.OPEN))return;L=w||Z();let z=self.location.protocol==="https:"?"wss:":"ws:",E=self.location.host,N=`${z}//${E}__WS_ROUTE__?connid=${L}`;try{j=new WebSocket(N),j.onopen=function(){console.log("[SharedWorker] WebSocket connected"),J=0,F({type:8,connectionId:L})},j.onclose=function(){if(console.log("[SharedWorker] WebSocket closed"),F({type:16}),H.size>0)V()},j.onerror=function(K){console.error("[SharedWorker] WebSocket error:",K),F({type:64,error:"WebSocket error"})},j.onmessage=function(K){K.data.split(`
`).filter((O)=>O.trim()).forEach((O)=>{F({type:32,data:O})})}}catch(K){if(console.error("[SharedWorker] Error creating WebSocket:",K),F({type:64,error:"Failed to create WebSocket connection"}),H.size>0)V()}}function F(w){H.forEach((z)=>{try{z.postMessage(w)}catch(E){console.error("[SharedWorker] Error sending message to client:",E)}})}function V(){if(J>=X){console.log("[SharedWorker] Maximum reconnection attempts reached"),F({type:64,error:"Maximum reconnection attempts reached"});return}let w=Math.min(1000*Math.pow(2,J),30000);J++,console.log(`[SharedWorker] Attempting to reconnect in ${w}ms (attempt ${J})`),F({type:128,attempt:J,delay:w}),clearTimeout(Q),Q=setTimeout(()=>{U(L)},w)}function Z(){return Date.now().toString()+Math.random().toString(36).substring(2,9)}
