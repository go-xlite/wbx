var H={workerRoute:"__WS_WORKER_ROUTE__",wsRoute:"__WS_ROUTE__"},Q=1,V=2,X=4,Y=8,Z=1,_=4,$=1,A=2,P=4,R=8;var E=1,L=2,M=4,f=8;class N{#G;#_;#F;#D;#$;#Y;#B;#j;#A;#Q;#Z;#f;#N;#V;#X;#O;#z;#P;#R;#q;constructor(j={}){if(this.#G=Object.assign({debug:!1,autoConnect:!0,reconnectOnDisconnect:!0,maxReconnectAttempts:10,connIdStorageKey:"ws-conn-id",modePrefStorageKey:"ws-mode-pref",coordinationChannel:"ws-coordination",coordinationHeartbeat:2000,assumeDisconnectedAfter:1e4},j),this.connectionId=this.#T(),this.connectionMode=localStorage.getItem(this.#G.modePrefStorageKey)||null,this.connectionState=1,this.broadcastChannel=null,this.#_=0,this.#F=null,this.#D=null,this.#$={[1]:[],[2]:[],[8]:[],[4]:[]},this.#Y={},this.#B=!1,this.#j=this.#v(),this.#A=null,this.#Q=null,this.#Z=!!this.connectionMode,this.#G.autoConnect)setTimeout(()=>this.connect(),0)}connect(){if(this.broadcastChannel&&!this.#B)return;if(this.connectionMode)switch(this.connectionMode){case 1:if(typeof SharedWorker<"u"){this.connectViaSharedWorker();return}break;case 4:this.connectDirectly();return}if(typeof SharedWorker<"u")this.connectViaSharedWorker();else this.connectDirectly()}setPreferredMode(j){if([1,4].includes(j)){if(this.connectionMode!==j)this.#W();return localStorage.setItem(this.#G.modePrefStorageKey,j),this.connectionMode=j,this.#Z=!0,!0}return!1}clearPreferredMode(){localStorage.removeItem(this.#G.modePrefStorageKey),this.connectionMode=null,this.#Z=!1}connectViaSharedWorker(){if(this.#W(),!this.broadcastChannel)this.initConnectionCoordination();try{this.#D=new SharedWorker(H.workerRoute),this.#D.port.start(),this.#D.port.addEventListener("message",(j)=>{this.#w(j.data)}),this.#D.port.postMessage({type:1,connectionId:this.connectionId}),this.connectionMode=1,this.#D.onerror=(j)=>{if(this.#H("SharedWorker error",j),this.#D=null,!this.#Z)this.connectDirectly();else this.#H("Not falling back because mode was explicitly set"),this.connectionState=8,this.#J(4,{message:"SharedWorker connection failed"})}}catch(j){if(this.#H("Failed to initialize SharedWorker",j),!this.#Z)this.connectDirectly();else this.#H("Not falling back because mode was explicitly set"),this.connectionState=8,this.#J(4,{message:"SharedWorker initialization failed"})}}connectDirectly(){if(this.#W(),this.broadcastChannel);let j=this.#h(),B=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}${H.wsRoute}?connid=${j}`;this.#F=new WebSocket(B),this.connectionMode=4,this.#F.onopen=()=>{this.connectionState=4,this.#_=0,this.#J(2)},this.#F.onclose=()=>{if(this.connectionState=1,this.#J(8),this.#G.reconnectOnDisconnect&&!this.#Z)this.#K()},this.#F.onerror=(D)=>{this.#H("Direct WebSocket error",D),this.#J(4,D)},this.#F.onmessage=(D)=>{D.data.split(`
`).filter((G)=>G.trim()).forEach((G)=>{this.#J(1,G)})}}#W(){if(this.connectionState=1,this.#D){try{if(this.#D.port.postMessage({type:2}),this.#D.port.close(),typeof this.#D.terminate==="function")this.#D.terminate()}catch(j){}this.#D=null}if(this.#F){try{this.#F.close()}catch(j){}this.#F=null}if(this.#q)clearTimeout(this.#q),this.#q=null;if(this.broadcastChannel)try{if(this.#B)this.broadcastChannel.postMessage({type:256,id:this.#j,timestamp:Date.now()});this.broadcastChannel.close(),this.broadcastChannel=null}catch(j){}}#b(){if(this.#f)window.removeEventListener("message",this.#f),this.#f=null}send(j){if(typeof j!=="string")j=JSON.stringify(j);if(this.broadcastChannel&&!this.#B){if(!this.#O)this.#O=new Map;let z=j,B=Date.now();if(this.#O.has(z)){let F=this.#O.get(z);if(B-F.timestamp<1000)return!0}let D=`${this.#j}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;return this.#O.set(z,{requestId:D,timestamp:B}),setTimeout(()=>{if(this.#O)this.#O.delete(z)},5000),this.broadcastChannel.postMessage({type:1,requestId:D,senderId:this.#j,id:this.#j,message:j,timestamp:B}),!0}if(this.connectionState!==4)return this.#H("Cannot send message, not connected"),!1;switch(this.connectionMode){case 1:this.#D.port.postMessage({type:4,data:j});break;case 4:if(this.#F&&this.#F.readyState===WebSocket.OPEN)this.#F.send(j);else return!1;break;default:return!1}return!0}#w(j){switch(j.type){case 8:this.connectionState=4,this.#J(2);break;case 16:if(this.connectionState=1,this.#J(8),this.#G.reconnectOnDisconnect)this.#D.port.postMessage({type:128,connectionId:this.connectionId});break;case 32:if(this.#J(1,j.data),this.broadcastChannel&&this.#B)this.broadcastChannel.postMessage({type:4,id:this.#j,message:j.data,timestamp:Date.now()});break;case 64:this.#H("WebSocket error via SharedWorker",j.error),this.#J(4,j.error);break;default:this.#H("Unknown message from SharedWorker",j)}}#C(j){try{if(!j||!j.type)return;if([1,2].includes(j.type)&&j.senderId===this.#j)return;switch(j.type){case 8:case 16:if(this.#z&&j.id!==this.#j){let z=this.#z.has(j.id);if(this.#z.set(j.id,{id:j.id,isPrimary:j.isPrimary,lastSeen:Date.now()}),!z)this.#E()}break;case 32:if(this.#j>j.id)this.broadcastChannel.postMessage({type:64,id:this.#j,timestamp:Date.now()}),setTimeout(()=>this.#M(),100);break;case 64:if(this.#Q)clearTimeout(this.#Q),this.#Q=null;break;case 128:if(j.id!==this.#j)this.#l();break;case 256:if(j.id!==this.#j)setTimeout(()=>this.#M(),100+Math.random()*400);break;case 4:if(j.id!==this.#j){if(!this.#B)this.#J(1,j.message)}break;case 1:if(this.#B&&j.id!==this.#j&&j.senderId!==this.#j){let z=j.requestId;if(!this.#V)this.#V=new Set;if(this.#V.has(z)){this.broadcastChannel.postMessage({type:2,requestId:j.requestId,targetId:j.senderId,senderId:this.#j,success:!1,duplicate:!0,timestamp:Date.now(),id:this.#j});return}this.#V.add(z),setTimeout(()=>{if(this.#V)this.#V.delete(z)},1e4);let B=!1;if(this.connectionState!==4){this.#H("Cannot forward message, primary not connected"),this.broadcastChannel.postMessage({type:2,requestId:j.requestId,targetId:j.senderId,senderId:this.#j,success:!1,error:"not_connected",timestamp:Date.now(),id:this.#j});return}switch(this.connectionMode){case 1:if(this.#D)this.#D.port.postMessage({type:4,data:j.message}),B=!0;break;case 4:if(this.#F&&this.#F.readyState===WebSocket.OPEN)this.#F.send(j.message),B=!0;break}this.broadcastChannel.postMessage({type:2,requestId:j.requestId,targetId:j.senderId,senderId:this.#j,success:B,timestamp:Date.now(),id:this.#j})}break;case 2:if(!this.#B&&j.targetId===this.#j){if(j.duplicate);else if(j.error==="not_connected");}break;case 512:if(this.#z&&j.id!==this.#j&&j.tabs){let z=!1;if(j.tabs.forEach((B)=>{if(B.id!==this.#j){let D=this.#z.has(B.id),F=D?this.#z.get(B.id):null;if(!D||F&&F.isPrimary!==B.isPrimary)this.#z.set(B.id,B),z=!0}}),z)this.#L(8,Array.from(this.#z.values()))}break;default:this.#H(`Unknown coordination message type: ${j.type}`,j);break}}catch(z){this.#H("Error handling coordination message",z)}}#K(){if(this.#_>=this.#G.maxReconnectAttempts){this.#H("Maximum reconnection attempts reached");return}let j=Math.min(1000*Math.pow(2,this.#_),30000);this.#_++,setTimeout(()=>{if(this.connectionState===1)this.connectDirectly()},j)}on(j,z){if(this.#$[j])this.#$[j].push(z);return this}#J(j,z){if(j===1){let B=typeof z==="string"?z:JSON.stringify(z);if(!this.#N)this.#N=new Map;let D=Date.now(),F=this.#N.get(B);if(F&&D-F<1000)return;if(this.#N.set(B,D),!this.#P)this.#P=setInterval(()=>{let G=Date.now()-5000;if(this.#N)this.#N.forEach((J,O)=>{if(J<G)this.#N.delete(O)})},1e4)}if(this.#$[j])this.#$[j].forEach((B)=>{try{B(z)}catch(D){}})}#T(){let j=localStorage.getItem(this.#G.connIdStorageKey);if(!j)j=this.#h(),localStorage.setItem(this.#G.connIdStorageKey,j);return j}#I(){return this.connectionId=this.#h(),localStorage.setItem(this.#G.connIdStorageKey,this.connectionId),this.connectionId}disconnect(j=!1){switch(this.connectionState=1,this.connectionMode){case 1:if(this.#D){try{this.#D.port.postMessage({type:2}),this.#D.port.close()}catch(z){}this.#D=null}break;case 4:if(this.#F){try{this.#F.close()}catch(z){}this.#F=null}break}if(!j&&this.#B&&this.broadcastChannel)this.broadcastChannel.postMessage({type:256,id:this.#j,timestamp:Date.now()});this.#J(8)}resetConnection(){return this.disconnect(),this.clearPreferredMode(),this.connectionId=this.#I(),this.connect()}#H(j,z){if(this.#G.debug)if(z)window.console.log(`[WebSocketManager] ${j}`,z);else window.console.log(`[WebSocketManager] ${j}`)}#c(){try{let j=new SharedWorker(H.workerRoute);j.port.start(),j.port.postMessage({type:256}),setTimeout(()=>{try{j.port.close()}catch(z){}},100)}catch(j){}try{let z=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}${H.wsRoute}?connid=${this.connectionId}&cleanup=1`,B=new WebSocket(z);B.onopen=()=>{B.send(JSON.stringify({type:1,previousMode:1,newMode:this.connectionMode})),setTimeout(()=>B.close(),50)}}catch(j){}}initConnectionCoordination(){if(typeof BroadcastChannel>"u")return!1;try{return this.broadcastChannel=new BroadcastChannel(this.#G.coordinationChannel),this.broadcastChannel.onmessage=(j)=>{if(!this.#X)this.#X=new Map;let z=JSON.stringify(j.data),B=Date.now(),D=this.#X.get(z);if(D&&B-D<100)return;if(this.#X.set(z,B),!this.#R)this.#R=setInterval(()=>{let F=Date.now()-1000;this.#X.forEach((G,J)=>{if(G<F)this.#X.delete(J)})},5000);this.#C(j.data)},this.#S(),this.#L(1),!0}catch(j){return this.#H("Error initializing coordination",j),!1}}#S(){this.#x(),this.#U(),this.#A=setInterval(()=>{this.#k()},this.#G.coordinationHeartbeat),this.#M(),this.#z=new Map,this.#z.set(this.#j,{id:this.#j,isPrimary:this.#B,lastSeen:Date.now()}),setInterval(()=>{this.#y()},this.#G.coordinationHeartbeat*2),document.addEventListener("visibilitychange",()=>{if(document.visibilityState==="visible"){if(this.#B)this.#B=!1;this.#U(),this.#M()}}),window.addEventListener("beforeunload",()=>{if(this.#B)this.broadcastChannel.postMessage({type:256,id:this.#j,timestamp:Date.now()})})}#x(){if(this.#A)clearInterval(this.#A),this.#A=null;if(this.#Q)clearTimeout(this.#Q),this.#Q=null}#U(){if(!this.broadcastChannel)return;if(this.broadcastChannel.postMessage({type:8,id:this.#j,timestamp:Date.now(),isPrimary:this.#B,connectionState:this.connectionState}),this.#z)this.#z.set(this.#j,{id:this.#j,isPrimary:this.#B,lastSeen:Date.now()}),this.#E()}#y(){if(!this.#z)return;let z=Date.now()-this.#G.assumeDisconnectedAfter*2,B=!1;if(this.#z.forEach((D,F)=>{if(D.lastSeen<z)this.#z.delete(F),B=!0}),B)this.#E()}#E(){if(!this.#z)return;let j=Array.from(this.#z.values());if(this.#L(8,j),this.broadcastChannel)this.broadcastChannel.postMessage({type:512,id:this.#j,timestamp:Date.now(),tabs:j})}#k(){if(!this.broadcastChannel)return;this.broadcastChannel.postMessage({type:16,id:this.#j,timestamp:Date.now(),isPrimary:this.#B,connectionState:this.connectionState})}#M(){if(!this.broadcastChannel)return;this.broadcastChannel.postMessage({type:32,id:this.#j,timestamp:Date.now()}),this.#Q=setTimeout(()=>{this.#u()},500)}#u(){if(this.#B)return;if(this.#B=!0,this.broadcastChannel.postMessage({type:128,id:this.#j,timestamp:Date.now()}),this.connectionState!==4)this.connect();if(this.#z)this.#z.set(this.#j,{id:this.#j,isPrimary:!0,lastSeen:Date.now()}),this.#E();this.#L(2)}#l(){if(!this.#B)return;if(this.#B=!1,this.connectionState===4)this.disconnect(!0);if(this.#z)this.#z.set(this.#j,{id:this.#j,isPrimary:!1,lastSeen:Date.now()}),this.#E();this.#L(4)}onCoordinationEvent(j,z){if(!this.#Y[j])this.#Y[j]=[];return this.#Y[j].push(z),this}#L(j,z){if(this.#Y[j])this.#Y[j].forEach((B)=>{try{B(z)}catch(D){}})}#v(){return Date.now().toString()+Math.random().toString(36).substring(2,9)}#h(){return Date.now().toString()+Math.random().toString(36).substring(2,9)}dispose(){if(this.disconnect(),this.#P)clearInterval(this.#P),this.#P=null;if(this.#R)clearInterval(this.#R),this.#R=null;if(this.#N)this.#N.clear();if(this.#V)this.#V.clear();if(this.#X)this.#X.clear();if(this.#O)this.#O.clear();if(this.broadcastChannel){if(this.#x(),this.#B)this.broadcastChannel.postMessage({type:256,id:this.#j,timestamp:Date.now()});this.broadcastChannel.close(),this.broadcastChannel=null}}getKnownTabs(){return this.#z?Array.from(this.#z.values()):[]}isPrimary(){return this.#B}}async function q(j={}){return new Promise((z)=>{let B=()=>{let D=new N(j);if(D.initConnectionCoordination)D.initConnectionCoordination();z(D)};if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",B);else B()})}export{q as createWebSocketManager,N as WebSocketManager,H as WS_CONFIG,Y as STATE_ERROR,Q as STATE_DISCONNECTED,V as STATE_CONNECTING,X as STATE_CONNECTED,Z as MODE_WORKER,_ as MODE_DIRECT,A as EVENT_OPEN,$ as EVENT_MESSAGE,P as EVENT_ERROR,R as EVENT_CLOSE,f as COORD_CB_TABS_UPDATED,E as COORD_CB_ENABLED,M as COORD_CB_BECAME_SECONDARY,L as COORD_CB_BECAME_PRIMARY};
