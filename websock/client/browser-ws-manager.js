var H={workerRoute:"__WS_WORKER_ROUTE__",iframeRoute:"__WS_IFRAME_ROUTE__",wsRoute:"__WS_ROUTE__"};class Q{constructor(j={}){if(this.options=Object.assign({debug:!1,autoConnect:!0,reconnectOnDisconnect:!0,maxReconnectAttempts:10,connIdStorageKey:"ws-conn-id",modePrefStorageKey:"ws-mode-pref",coordinationChannel:"ws-coordination",coordinationHeartbeat:2000,assumeDisconnectedAfter:5000},j),this.connectionId=this.getStoredConnectionId(),this.connectionMode=localStorage.getItem(this.options.modePrefStorageKey)||null,this.connectionState="disconnected",this.reconnectAttempts=0,this.socket=null,this.worker=null,this.iframe=null,this.callbacks={message:[],open:[],close:[],error:[]},this.broadcastChannel=null,this.coordinationCallbacks={},this.isPrimaryConnection=!1,this.coordinationId=this.generateInstanceId(),this.lastHeartbeat=null,this.heartbeatInterval=null,this.electionTimeout=null,this.explicitModeSet=!!this.connectionMode,this.options.autoConnect)setTimeout(()=>this.connect(),0)}connect(){if(this.broadcastChannel&&!this.isPrimaryConnection){this.log("This is a secondary connection, not connecting");return}if(this.connectionMode)switch(this.log(`Using preferred connection mode: ${this.connectionMode}`),this.connectionMode){case"worker":if(typeof SharedWorker<"u"){this.connectViaSharedWorker();return}this.log("SharedWorker not supported, falling back to default selection");break;case"iframe":this.connectViaIframe();return;case"direct":this.connectDirectly();return}if(this.log("Attempting to connect using best available method"),typeof SharedWorker<"u")this.log("SharedWorker is supported, trying this method first"),this.connectViaSharedWorker();else if(this.canUseIframe())this.log("Using iframe fallback method"),this.connectViaIframe();else this.log("Using direct WebSocket connection"),this.connectDirectly()}setPreferredMode(j){if(["worker","iframe","direct"].includes(j)){if(this.connectionMode!==j)this.cleanupCurrentConnection(),setTimeout(()=>{if(this.connectionMode==="worker"&&j!=="worker")this.clearSharedWorkers()},100);return localStorage.setItem(this.options.modePrefStorageKey,j),this.connectionMode=j,this.explicitModeSet=!0,this.log(`Set preferred connection mode to: ${j}`),!0}return!1}clearPreferredMode(){localStorage.removeItem(this.options.modePrefStorageKey),this.connectionMode=null,this.explicitModeSet=!1,this.log("Cleared preferred connection mode")}connectViaSharedWorker(){this.cleanupCurrentConnection();try{this.worker=new SharedWorker(H.workerRoute),this.worker.port.start(),this.worker.port.addEventListener("message",(j)=>{this.handleWorkerMessage(j.data)}),this.worker.port.postMessage({type:"CONNECT",connectionId:this.connectionId}),this.connectionMode="worker",this.worker.onerror=(j)=>{if(this.log("SharedWorker error",j),this.worker=null,!this.explicitModeSet)if(this.canUseIframe())this.connectViaIframe();else this.connectDirectly();else this.log("Not falling back because mode was explicitly set"),this.connectionState="error",this.triggerCallback("error",{message:"SharedWorker connection failed"})}}catch(j){if(this.log("Failed to initialize SharedWorker",j),!this.explicitModeSet)if(this.canUseIframe())this.connectViaIframe();else this.connectDirectly();else this.log("Not falling back because mode was explicitly set"),this.connectionState="error",this.triggerCallback("error",{message:"SharedWorker initialization failed"})}}connectViaIframe(){if(this.cleanupCurrentConnection(),!document.body){this.log("Document body not available yet, delaying iframe creation"),setTimeout(()=>this.connectViaIframe(),100);return}try{this.iframe=document.createElement("iframe"),this.iframe.style.display="none",this.iframe.src=H.iframeRoute,this.removeMessageListener(),this.messageListener=(j)=>{if(this.iframe&&j.source===this.iframe.contentWindow)this.handleIframeMessage(j.data)},window.addEventListener("message",this.messageListener),document.body.appendChild(this.iframe),this.connectionMode="iframe"}catch(j){if(this.log("Error creating iframe",j),!this.explicitModeSet)this.connectDirectly();else this.connectionState="error",this.triggerCallback("error",{message:"Failed to create iframe connection"})}}connectDirectly(){this.cleanupCurrentConnection();let z=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}${H.wsRoute}?connid=${this.connectionId}`;this.socket=new WebSocket(z),this.connectionMode="direct",this.socket.onopen=()=>{this.log("Direct WebSocket connected"),this.connectionState="connected",this.reconnectAttempts=0,this.triggerCallback("open")},this.socket.onclose=()=>{if(this.log("Direct WebSocket closed"),this.connectionState="disconnected",this.triggerCallback("close"),this.options.reconnectOnDisconnect&&!this.explicitModeSet)this.attemptReconnect()},this.socket.onerror=(A)=>{this.log("Direct WebSocket error",A),this.triggerCallback("error",A)},this.socket.onmessage=(A)=>{this.log("Direct WebSocket message received",A.data),this.triggerCallback("message",A.data)}}cleanupCurrentConnection(){if(this.connectionState="disconnected",this.worker){try{if(this.worker.port.postMessage({type:"DISCONNECT"}),this.worker.port.close(),typeof this.worker.terminate==="function")this.worker.terminate();this.log("Worker connection terminated")}catch(j){this.log("Error cleaning up worker",j)}this.worker=null}if(this.iframe){try{if(this.removeMessageListener(),document.body.contains(this.iframe))document.body.removeChild(this.iframe)}catch(j){this.log("Error cleaning up iframe",j)}this.iframe=null}if(this.socket){try{this.socket.close()}catch(j){this.log("Error cleaning up direct socket",j)}this.socket=null}if(this.reconnectTimeout)clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null}removeMessageListener(){if(this.messageListener)window.removeEventListener("message",this.messageListener),this.messageListener=null}send(j){if(typeof j!=="string")j=JSON.stringify(j);if(this.broadcastChannel&&!this.isPrimaryConnection){if(this.log("Sending message via coordination channel (secondary tab)"),!this.pendingSendRequests)this.pendingSendRequests=new Map;let z=j,A=Date.now();if(this.pendingSendRequests.has(z)){let D=this.pendingSendRequests.get(z);if(A-D.timestamp<1000)return this.log("Duplicate send request detected, ignoring"),!0}let B=`${this.coordinationId}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;return this.pendingSendRequests.set(z,{requestId:B,timestamp:A}),setTimeout(()=>{if(this.pendingSendRequests)this.pendingSendRequests.delete(z)},5000),this.broadcastChannel.postMessage({type:"send-request",requestId:B,senderId:this.coordinationId,id:this.coordinationId,message:j,timestamp:A}),!0}if(this.connectionState!=="connected")return this.log("Cannot send message, not connected"),!1;switch(this.connectionMode){case"worker":this.worker.port.postMessage({type:"SEND",data:j});break;case"iframe":if(this.iframe&&this.iframe.contentWindow)this.iframe.contentWindow.postMessage({type:"WS_SEND",data:j},"*");else return!1;break;case"direct":if(this.socket&&this.socket.readyState===WebSocket.OPEN)this.socket.send(j);else return!1;break;default:return!1}return!0}handleWorkerMessage(j){switch(j.type){case"CONNECTED":this.log("WebSocket connected via SharedWorker"),this.connectionState="connected",this.triggerCallback("open");break;case"DISCONNECTED":if(this.log("WebSocket disconnected via SharedWorker"),this.connectionState="disconnected",this.triggerCallback("close"),this.options.reconnectOnDisconnect)this.worker.port.postMessage({type:"RECONNECT",connectionId:this.connectionId});break;case"MESSAGE":if(this.log("WebSocket message received via SharedWorker",j.data),this.triggerCallback("message",j.data),this.broadcastChannel&&this.isPrimaryConnection)this.broadcastChannel.postMessage({type:"message-relay",id:this.coordinationId,message:j.data,timestamp:Date.now()});break;case"ERROR":this.log("WebSocket error via SharedWorker",j.error),this.triggerCallback("error",j.error);break;default:this.log("Unknown message from SharedWorker",j)}}handleIframeMessage(j){switch(j.type){case"WS_CONNECTED":this.log("WebSocket connected via iframe"),this.connectionState="connected",this.triggerCallback("open");break;case"WS_CLOSED":this.log("WebSocket disconnected via iframe"),this.connectionState="disconnected",this.triggerCallback("close");break;case"WS_MESSAGE":if(this.log("WebSocket message received via iframe",j.data),this.triggerCallback("message",j.data),this.broadcastChannel&&this.isPrimaryConnection)this.broadcastChannel.postMessage({type:"message-relay",id:this.coordinationId,message:j.data,timestamp:Date.now()});break;case"WS_ERROR":this.log("WebSocket error via iframe"),this.triggerCallback("error",{message:"WebSocket error in iframe"});break;case"WS_RECONNECTING":this.log(`Reconnecting via iframe (attempt ${j.attempt} after ${j.delay}ms)`);break;case"WS_MAX_RECONNECT_ATTEMPTS":this.log("Maximum reconnection attempts reached in iframe");break;default:this.log("Unknown message from iframe",j)}}handleCoordinationMessage(j){try{if(!j||!j.type){this.log("Received invalid coordination message",j);return}if(["send-request","send-response"].includes(j.type)&&j.senderId===this.coordinationId)return;switch(j.type){case"presence":case"heartbeat":if(this.lastHeartbeat=Date.now(),this.knownTabs&&j.id!==this.coordinationId){let z=this.knownTabs.has(j.id);if(this.knownTabs.set(j.id,{id:j.id,isPrimary:j.isPrimary,lastSeen:Date.now()}),!z)this.broadcastTabsUpdate()}break;case"election":if(this.coordinationId>j.id)this.broadcastChannel.postMessage({type:"election-objection",id:this.coordinationId,timestamp:Date.now()}),setTimeout(()=>this.initiateElection(),100);break;case"election-objection":if(this.electionTimeout)clearTimeout(this.electionTimeout),this.electionTimeout=null;break;case"primary-elected":if(j.id!==this.coordinationId)this.becomeSecondary();break;case"primary-disconnected":if(j.id!==this.coordinationId)setTimeout(()=>this.initiateElection(),100+Math.random()*400);break;case"message-relay":if(j.id!==this.coordinationId)if(!this.isPrimaryConnection)this.log("Received relayed message in secondary tab"),this.triggerCallback("message",j.message);else this.log("Ignoring relayed message in primary tab (already received directly)");break;case"send-request":if(this.isPrimaryConnection&&j.id!==this.coordinationId&&j.senderId!==this.coordinationId){this.log("Received send request from secondary tab");let z=j.requestId;if(!this.recentlySentMessages)this.recentlySentMessages=new Set;if(this.recentlySentMessages.has(z)){this.log("Duplicate send request detected, ignoring"),this.broadcastChannel.postMessage({type:"send-response",requestId:j.requestId,targetId:j.senderId,senderId:this.coordinationId,success:!1,duplicate:!0,timestamp:Date.now(),id:this.coordinationId});return}this.recentlySentMessages.add(z),setTimeout(()=>{if(this.recentlySentMessages)this.recentlySentMessages.delete(z)},1e4);let A=!1;if(this.connectionState!=="connected"){this.log("Cannot forward message, primary not connected"),this.broadcastChannel.postMessage({type:"send-response",requestId:j.requestId,targetId:j.senderId,senderId:this.coordinationId,success:!1,error:"not_connected",timestamp:Date.now(),id:this.coordinationId});return}switch(this.connectionMode){case"worker":if(this.worker)this.worker.port.postMessage({type:"SEND",data:j.message}),A=!0;break;case"iframe":if(this.iframe&&this.iframe.contentWindow)this.iframe.contentWindow.postMessage({type:"WS_SEND",data:j.message},"*"),A=!0;break;case"direct":if(this.socket&&this.socket.readyState===WebSocket.OPEN)this.socket.send(j.message),A=!0;break}this.broadcastChannel.postMessage({type:"send-response",requestId:j.requestId,targetId:j.senderId,senderId:this.coordinationId,success:A,timestamp:Date.now(),id:this.coordinationId})}break;case"send-response":if(!this.isPrimaryConnection&&j.targetId===this.coordinationId)if(j.duplicate)this.log("Send request was duplicate");else if(j.error==="not_connected")this.log("Send request failed: primary not connected");else this.log(`Send request ${j.success?"succeeded":"failed"}`);break;case"tabs-status":if(this.knownTabs&&j.id!==this.coordinationId&&j.tabs){let z=!1;if(j.tabs.forEach((A)=>{if(A.id!==this.coordinationId){let B=this.knownTabs.has(A.id),D=B?this.knownTabs.get(A.id):null;if(!B||D&&D.isPrimary!==A.isPrimary)this.knownTabs.set(A.id,A),z=!0}}),z)this.triggerCoordinationCallback("tabs-updated",Array.from(this.knownTabs.values()))}break;default:this.log(`Unknown coordination message type: ${j.type}`,j);break}}catch(z){this.log("Error handling coordination message",z)}}attemptReconnect(){if(this.reconnectAttempts>=this.options.maxReconnectAttempts){this.log("Maximum reconnection attempts reached");return}let j=Math.min(1000*Math.pow(2,this.reconnectAttempts),30000);this.reconnectAttempts++,this.log(`Attempting to reconnect in ${j}ms (attempt ${this.reconnectAttempts})`),setTimeout(()=>{if(this.connectionState==="disconnected")this.connectDirectly()},j)}on(j,z){if(this.callbacks[j])this.callbacks[j].push(z);return this}triggerCallback(j,z){if(j==="message"){let A=typeof z==="string"?z:JSON.stringify(z);if(!this.recentMessages)this.recentMessages=new Map;let B=Date.now(),D=this.recentMessages.get(A);if(D&&B-D<1000){this.log("Duplicate message detected within 1 second, ignoring");return}if(this.recentMessages.set(A,B),!this.messageCleanupInterval)this.messageCleanupInterval=setInterval(()=>{let J=Date.now()-5000;if(this.recentMessages)this.recentMessages.forEach((P,U)=>{if(P<J)this.recentMessages.delete(U)})},1e4)}if(this.callbacks[j])this.callbacks[j].forEach((A)=>{try{A(z)}catch(B){console.error("Error in WebSocket callback",B)}})}canUseIframe(){return!0}getStoredConnectionId(){let j=localStorage.getItem(this.options.connIdStorageKey);if(!j)j=this.generateConnectionId(),localStorage.setItem(this.options.connIdStorageKey,j);return j}resetConnectionId(){return this.connectionId=this.generateConnectionId(),localStorage.setItem(this.options.connIdStorageKey,this.connectionId),this.connectionId}disconnect(j=!1){switch(this.connectionState="disconnected",this.connectionMode){case"worker":if(this.worker){try{this.worker.port.postMessage({type:"DISCONNECT"}),this.worker.port.close()}catch(z){this.log("Error closing worker",z)}this.worker=null}break;case"iframe":if(this.iframe){this.removeMessageListener();try{document.body.removeChild(this.iframe)}catch(z){this.log("Error removing iframe",z)}this.iframe=null}break;case"direct":if(this.socket){try{this.socket.close()}catch(z){this.log("Error closing socket",z)}this.socket=null}break}if(!j&&this.isPrimaryConnection&&this.broadcastChannel)this.broadcastChannel.postMessage({type:"primary-disconnected",id:this.coordinationId,timestamp:Date.now()});this.triggerCallback("close")}resetConnection(){return this.disconnect(),this.clearPreferredMode(),this.connectionId=this.resetConnectionId(),this.connect()}log(j,z){if(this.options.debug)if(z)console.log(`[WebSocketManager] ${j}`,z);else console.log(`[WebSocketManager] ${j}`)}clearSharedWorkers(){this.log("Attempting to clear SharedWorkers");try{let j=new SharedWorker(H.workerRoute);j.port.start(),j.port.postMessage({type:"GLOBAL_SHUTDOWN"}),setTimeout(()=>{try{j.port.close()}catch(z){}},100)}catch(j){this.log("Error creating temporary worker for cleanup",j)}try{let z=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}${H.wsRoute}?connid=${this.connectionId}&cleanup=1`,A=new WebSocket(z);A.onopen=()=>{A.send(JSON.stringify({type:"mode_change",previousMode:"worker",newMode:this.connectionMode})),setTimeout(()=>A.close(),50)}}catch(j){this.log("Error sending cleanup notification",j)}}initConnectionCoordination(){if(typeof BroadcastChannel>"u")return this.log("BroadcastChannel not supported, coordination disabled"),!1;try{return this.broadcastChannel=new BroadcastChannel(this.options.coordinationChannel),this.broadcastChannel.onmessage=(j)=>{if(!this.recentCoordinationMessages)this.recentCoordinationMessages=new Map;let z=JSON.stringify(j.data),A=Date.now(),B=this.recentCoordinationMessages.get(z);if(B&&A-B<100)return;if(this.recentCoordinationMessages.set(z,A),!this.coordinationCleanupInterval)this.coordinationCleanupInterval=setInterval(()=>{let D=Date.now()-1000;this.recentCoordinationMessages.forEach((J,P)=>{if(J<D)this.recentCoordinationMessages.delete(P)})},5000);this.handleCoordinationMessage(j.data)},this.startCoordination(),this.triggerCoordinationCallback("coordination-enabled"),!0}catch(j){return this.log("Error initializing coordination",j),!1}}startCoordination(){this.clearCoordinationTimers(),this.broadcastPresence(),this.heartbeatInterval=setInterval(()=>{this.broadcastHeartbeat()},this.options.coordinationHeartbeat),this.initiateElection(),this.knownTabs=new Map,this.knownTabs.set(this.coordinationId,{id:this.coordinationId,isPrimary:this.isPrimaryConnection,lastSeen:Date.now()}),setInterval(()=>{this.cleanupStaleTabsAndUpdateStatus()},this.options.coordinationHeartbeat*2),document.addEventListener("visibilitychange",()=>{if(document.visibilityState==="visible"){if(this.broadcastPresence(),this.isPrimaryConnection)this.initiateElection()}}),window.addEventListener("beforeunload",()=>{if(this.isPrimaryConnection)this.broadcastChannel.postMessage({type:"primary-disconnected",id:this.coordinationId,timestamp:Date.now()})})}clearCoordinationTimers(){if(this.heartbeatInterval)clearInterval(this.heartbeatInterval),this.heartbeatInterval=null;if(this.electionTimeout)clearTimeout(this.electionTimeout),this.electionTimeout=null}broadcastPresence(){if(!this.broadcastChannel)return;if(this.broadcastChannel.postMessage({type:"presence",id:this.coordinationId,timestamp:Date.now(),isPrimary:this.isPrimaryConnection,connectionState:this.connectionState}),this.knownTabs)this.knownTabs.set(this.coordinationId,{id:this.coordinationId,isPrimary:this.isPrimaryConnection,lastSeen:Date.now()}),this.broadcastTabsUpdate()}cleanupStaleTabsAndUpdateStatus(){if(!this.knownTabs)return;let z=Date.now()-this.options.assumeDisconnectedAfter*2,A=!1;if(this.knownTabs.forEach((B,D)=>{if(B.lastSeen<z)this.knownTabs.delete(D),A=!0}),A)this.broadcastTabsUpdate()}broadcastTabsUpdate(){if(!this.knownTabs)return;let j=Array.from(this.knownTabs.values());if(this.triggerCoordinationCallback("tabs-updated",j),this.broadcastChannel)this.broadcastChannel.postMessage({type:"tabs-status",id:this.coordinationId,timestamp:Date.now(),tabs:j})}broadcastHeartbeat(){if(!this.broadcastChannel)return;this.broadcastChannel.postMessage({type:"heartbeat",id:this.coordinationId,timestamp:Date.now(),isPrimary:this.isPrimaryConnection,connectionState:this.connectionState})}initiateElection(){if(!this.broadcastChannel)return;this.broadcastChannel.postMessage({type:"election",id:this.coordinationId,timestamp:Date.now()}),this.electionTimeout=setTimeout(()=>{this.becomePrimary()},500)}becomePrimary(){if(this.isPrimaryConnection)return;if(this.log("Becoming primary connection"),this.isPrimaryConnection=!0,this.broadcastChannel.postMessage({type:"primary-elected",id:this.coordinationId,timestamp:Date.now()}),this.connectionState!=="connected")this.connect();if(this.knownTabs)this.knownTabs.set(this.coordinationId,{id:this.coordinationId,isPrimary:!0,lastSeen:Date.now()}),this.broadcastTabsUpdate();this.triggerCoordinationCallback("became-primary")}becomeSecondary(){if(!this.isPrimaryConnection)return;if(this.log("Becoming secondary connection"),this.isPrimaryConnection=!1,this.connectionState==="connected")this.disconnect(!0);if(this.knownTabs)this.knownTabs.set(this.coordinationId,{id:this.coordinationId,isPrimary:!1,lastSeen:Date.now()}),this.broadcastTabsUpdate();this.triggerCoordinationCallback("became-secondary")}onCoordinationEvent(j,z){if(!this.coordinationCallbacks[j])this.coordinationCallbacks[j]=[];return this.coordinationCallbacks[j].push(z),this}triggerCoordinationCallback(j,z){if(this.coordinationCallbacks[j])this.coordinationCallbacks[j].forEach((A)=>{try{A(z)}catch(B){console.error("Error in coordination callback",B)}})}generateInstanceId(){return Date.now().toString()+Math.random().toString(36).substring(2,9)}generateConnectionId(){return Date.now().toString()+Math.random().toString(36).substring(2,9)}dispose(){if(this.disconnect(),this.messageCleanupInterval)clearInterval(this.messageCleanupInterval),this.messageCleanupInterval=null;if(this.coordinationCleanupInterval)clearInterval(this.coordinationCleanupInterval),this.coordinationCleanupInterval=null;if(this.recentMessages)this.recentMessages.clear();if(this.recentlySentMessages)this.recentlySentMessages.clear();if(this.recentCoordinationMessages)this.recentCoordinationMessages.clear();if(this.pendingSendRequests)this.pendingSendRequests.clear();if(this.broadcastChannel){if(this.clearCoordinationTimers(),this.isPrimaryConnection)this.broadcastChannel.postMessage({type:"primary-disconnected",id:this.coordinationId,timestamp:Date.now()});this.broadcastChannel.close(),this.broadcastChannel=null}}getKnownTabs(){return this.knownTabs?Array.from(this.knownTabs.values()):[]}isPrimary(){return this.isPrimaryConnection}}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{if(window.wsManager=new Q({debug:!0}),window.wsManager.initConnectionCoordination)window.wsManager.initConnectionCoordination()});else if(window.wsManager=new Q({debug:!0}),window.wsManager.initConnectionCoordination)window.wsManager.initConnectionCoordination();
