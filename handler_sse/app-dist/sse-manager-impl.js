class B{#q=!1;#F=0;#V;#j=null;#A=null;#N;#K=null;#B=null;#Q=null;#R=null;#U=null;#W;#X;#Y;#Z;#$;#x;#z;#O;constructor(j,q={}){this.#V=j,this.#z=this.#H(),this.#N="sse-coord-"+btoa(j).replace(/=/g,""),this.ops={reconnect:q.reconnect??!0,reconnectInterval:q.reconnectInterval??5000,heartbeatInterval:q.heartbeatInterval??2000,electionTimeout:q.electionTimeout??500,failoverCheckInterval:q.failoverCheckInterval??1e4},this.#W=[],this.#X=[],this.#Y=[],this.#Z=[],this.#$=[],this.#x=[],this.#O=()=>this.disconnect(),window.addEventListener("beforeunload",this.#O),window.addEventListener("pagehide",this.#O)}#H(){return Date.now().toString()+"-"+Math.random().toString(36).substr(2,9)}connect(){if(this.#F!==0)return;if(this.#j)this.#j.close(),this.#j=null;this.#F=1,this.#f()}disconnect(){if(this.ops.reconnect=!1,this.#I(),this.#j)this.#j.onopen=null,this.#j.onmessage=null,this.#j.onerror=null,this.#j.close(),this.#j=null;if(this.#F=0,this.#q=!1,this.#A)this.#A.postMessage({type:105,instanceId:this.#z}),this.#A.close(),this.#A=null;if(this.#O)window.removeEventListener("beforeunload",this.#O),window.removeEventListener("pagehide",this.#O);this.#J(3)}#f(){try{this.#A=new BroadcastChannel(this.#N),this.#A.onmessage=(j)=>{this.#E(j.data)},this.#A.postMessage({type:101,instanceId:this.#z}),this.#B=setTimeout(()=>{this.#G()},this.ops.electionTimeout)}catch(j){this.#L()}}#E(j){switch(j.type){case 101:if(this.#q)this.#A.postMessage({type:102,instanceId:this.#z});break;case 102:if(!this.#q&&j.instanceId!==this.#z)clearTimeout(this.#B),this.#w();break;case 103:if(!this.#q&&j.instanceId!==this.#z)this.#U=Date.now();break;case 104:if(!this.#q)this.#J(0,j.message);break;case 105:if(!this.#q&&j.instanceId!==this.#z)clearTimeout(this.#B),this.#B=setTimeout(()=>this.#G(),100);break;case 106:if(j.instanceId!==this.#z)if(j.instanceId<this.#z)if(this.#q)this.#D();else clearTimeout(this.#B);else this.#A.postMessage({type:107,instanceId:this.#z});break;case 107:if(j.instanceId<this.#z&&j.instanceId!==this.#z){if(clearTimeout(this.#B),this.#q)this.#D()}break;case 100:if(j.instanceId!==this.#z)if(this.#q){if(j.instanceId<this.#z)this.#D()}else this.#U=Date.now();break}}#G(){if(!this.#A){this.#L();return}this.#A.postMessage({type:106,instanceId:this.#z}),clearTimeout(this.#B),this.#B=setTimeout(()=>{if(!this.#q)this.#L()},500)}#L(){if(this.#q)return;if(this.#q=!0,this.#F=2,this.#A)this.#A.postMessage({type:100,instanceId:this.#z});this.#M(),this.#K=setInterval(()=>{if(this.#A&&this.#q)this.#A.postMessage({type:103,instanceId:this.#z})},this.ops.heartbeatInterval),this.#J(4)}#w(){if(!this.#q&&this.#j)return;this.#q=!1,this.#F=2,this.#U=Date.now(),this.#R=setInterval(()=>{if(Date.now()-(this.#U||0)>this.ops.failoverCheckInterval)this.#G()},this.ops.failoverCheckInterval),this.#J(5),this.#J(1)}#D(){if(this.#j)this.#j.close(),this.#j=null;if(this.#K)clearInterval(this.#K),this.#K=null;this.#q=!1,this.#w()}#M(){if(this.#j)this.#j.onopen=null,this.#j.onmessage=null,this.#j.onerror=null,this.#j.close(),this.#j=null;this.#j=new EventSource(this.#V),this.#j.onopen=()=>{this.#F=2,this.#J(1)},this.#j.onmessage=(j)=>{if(this.#J(0,j.data),this.#q&&this.#A)this.#A.postMessage({type:104,message:j.data,instanceId:this.#z})},this.#j.onerror=(j)=>{if(this.#J(2,j),this.#j.readyState===EventSource.CLOSED)this.#_()}}#_(){if(this.#F=0,this.#j)this.#j.close(),this.#j=null;if(this.#J(3),this.ops.reconnect&&this.#q)this.#Q=setTimeout(()=>{if(this.#q)this.#M()},this.ops.reconnectInterval)}#I(){if(this.#K)clearInterval(this.#K),this.#K=null;if(this.#B)clearTimeout(this.#B),this.#B=null;if(this.#Q)clearTimeout(this.#Q),this.#Q=null;if(this.#R)clearInterval(this.#R),this.#R=null}on(j,q){switch(j){case 0:this.#W.push(q);break;case 1:this.#X.push(q);break;case 2:this.#Y.push(q);break;case 3:this.#Z.push(q);break;case 4:this.#$.push(q);break;case 5:this.#x.push(q);break}}#J(j,q){let z;switch(j){case 0:z=this.#W;break;case 1:z=this.#X;break;case 2:z=this.#Y;break;case 3:z=this.#Z;break;case 4:z=this.#$;break;case 5:z=this.#x;break}if(z)z.forEach((A)=>A(q))}isPrimaryConnection(){return this.#q}getConnectionState(){return this.#F}getState(){let j={};return j.connectionState=this.#F,j.isPrimary=this.#q,j.instanceId=this.#z,j.url=this.#V,j}}export{B as SSEManager};
