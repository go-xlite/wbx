var y=1,U=2,A=4,P=8,B=16,S=32,H=64,G=128,u=256,V=new Set,w=null,j=null,Y=0,q=null,X=!1,Z=!1,b=10;self.onconnect=function(F){let z=F.ports[0];if(V.add(z),z.start(),z.addEventListener("message",function(J){v(J.data,z)}),z.addEventListener("close",function(){if(V.delete(z),V.size===0&&w)w.close(),w=null,clearTimeout(q)}),w&&w.readyState===WebSocket.OPEN)z.postMessage({type:P,connectionId:j})};function v(F,z){switch(F.type){case y:if(!w||w.readyState!==WebSocket.OPEN)X=!1,Y=0,clearTimeout(q),Z=!1,f(F.connectionId);break;case U:if(w)w.close(),w=null;break;case A:if(w&&w.readyState===WebSocket.OPEN)w.send(F.data);else z.postMessage({type:H,error:"Socket not connected"});break;case G:break;case u:if(w)w.close(),w=null;Q({type:B,reason:"global_shutdown"}),V.forEach((J)=>{try{J.close()}catch($){}}),V.clear();try{self.close()}catch(J){}break}}function f(F){if(w&&(w.readyState===WebSocket.CONNECTING||w.readyState===WebSocket.OPEN))return;j=F||D();let z=self.location.protocol==="https:"?"wss:":"ws:",J=self.location.host,$=self.location.pathname.split("/").slice(0,-2).join("/")+"/connect",h=`${z}//${J}${$}?connid=${j}`;try{w=new WebSocket(h),w.onopen=function(){Y=0,X=!1,Z=!1,clearTimeout(q),Q({type:P,connectionId:j})},w.onclose=function(){if(w=null,Q({type:B}),Z=!1,V.size>0&&!X)M()},w.onerror=function(x){if(!X)Q({type:H,error:"WebSocket error"})},w.onmessage=function(x){x.data.split(`
`).filter((L)=>L.trim()).forEach((L)=>{Q({type:S,data:L})})}}catch(x){if(w=null,!X)Q({type:H,error:"Failed to create WebSocket connection"});if(Z=!1,V.size>0&&!X)M()}}function Q(F){V.forEach((z)=>{try{z.postMessage(F)}catch(J){}})}function M(){if(Z)return;if(Y>=b){X=!0,Q({type:H,error:"Maximum reconnection attempts reached"});return}Z=!0;let F=2000*Math.pow(2,Y),z=60000,J=0.8+Math.random()*0.4,$=Math.min(Math.floor(F*J),z);Y++,Q({type:G,attempt:Y,delay:$}),clearTimeout(q),q=setTimeout(()=>{f(j)},$)}function D(){return Date.now().toString()+Math.random().toString(36).substring(2,9)}
