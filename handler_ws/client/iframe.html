{{define "socket-iframe"}}
<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Iframe Polyfill</title>
    <script>
        // Initialize WebSocket
        let socket = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 10;
        
        function connectWebSocket() {
            const connId = localStorage.getItem('ws-conn-id') || generateConnId();
            localStorage.setItem('ws-conn-id', connId);
            
            socket = new WebSocket(getWebSocketUrl(connId));
            
            socket.onopen = function() {
                console.log("Socket iframe connected");
                reconnectAttempts = 0;
                window.parent.postMessage({type: 'WS_CONNECTED'}, '*');
            };
            
            socket.onclose = function() {
                console.log("Socket iframe closed");
                window.parent.postMessage({type: 'WS_CLOSED'}, '*');
                reconnectWithBackoff();
            };
            
            socket.onerror = function(error) {
                console.error("Socket iframe error:", error);
                window.parent.postMessage({type: 'WS_ERROR'}, '*');
            };
            
            socket.onmessage = function(event) {
                console.log("Message received in iframe");
                window.parent.postMessage({
                    type: 'WS_MESSAGE',
                    data: event.data
                }, '*');
            };
        }
        
        function getWebSocketUrl(connId) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            return protocol + '//' + window.location.host + '{{ .Route }}?connid=' + connId;
        }
        
        function generateConnId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 9);
        }
        
        function reconnectWithBackoff() {
            if (reconnectAttempts >= maxReconnectAttempts) {
                window.parent.postMessage({type: 'WS_MAX_RECONNECT_ATTEMPTS'}, '*');
                return;
            }
            
            const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
            reconnectAttempts++;
            
            window.parent.postMessage({
                type: 'WS_RECONNECTING',
                attempt: reconnectAttempts,
                delay: delay
            }, '*');
            
            setTimeout(connectWebSocket, delay);
        }
        
        // Listen for messages from the parent window
        window.addEventListener('message', function(event) {
            if (event.data.type === 'WS_SEND' && socket && socket.readyState === WebSocket.OPEN) {
                socket.send(event.data.data);
            }
        });
        
        // Initialize connection when the iframe loads
        window.addEventListener('load', connectWebSocket);
    </script>
</head>
<body>
    <p>WebSocket Connection Frame</p>
</body>
</html>
{{end}}