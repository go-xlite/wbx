var O=1,Q=2,V=4,X=8,Y=1,Z=4,_=1,$=2,A=4,P=1,R=2,E=4,L=8;var f=1,q=2,W=4,h=8;class J{#B;#$;#G;#F;#A;#Z;#D;#j;#P;#V;#_;#h;#O;#X;#Y;#Q;#z;#R;#E;#C;constructor(j={}){if(!j.wsRoute||!j.wsWorkerRoute||!j.endpoint)throw Error("wsRoute, wsWorkerRoute, and endpoint options are required");this.#B=Object.assign({debug:!1,wsRoute:j.wsRoute,workerRoute:j.wsWorkerRoute,autoConnect:!0,reconnectOnDisconnect:!0,maxReconnectAttempts:10,endpoint:j.endpoint,sessionStrategy:2,connIdStorageKey:"ws-conn-id",sessionIdStorageKey:"ws-session-id",modePrefStorageKey:"ws-mode-pref",coordinationChannel:"ws-coordination",coordinationHeartbeat:2000,assumeDisconnectedAfter:1e4},j),this.#B.endpointKey=this.#B.endpoint.replace(/\//g,"-"),this.connectionId=this.#l(),this.sessionId=this.#u(),this.sessionData=this.#y(),this.sessionStrategy=this.#B.sessionStrategy;let z=localStorage.getItem(this.#N("modePref"));if(this.connectionMode=z?parseInt(z,10):null,this.connectionState=1,this.broadcastChannel=null,this.#$=0,this.#G=null,this.#F=null,this.#A={[1]:[],[2]:[],[8]:[],[4]:[]},this.#Z={},this.#D=!1,this.#j=this.#w(),this.#P=null,this.#V=null,this.#_=!!this.connectionMode,this.#B.autoConnect)setTimeout(()=>this.connect(),0)}connect(){if(this.broadcastChannel&&!this.#D)return;if(this.connectionMode)switch(this.connectionMode){case 1:if(typeof SharedWorker<"u"){this.connectViaSharedWorker();return}break;case 4:this.connectDirectly();return}if(typeof SharedWorker<"u")this.connectViaSharedWorker();else this.connectDirectly()}setPreferredMode(j){if([1,4].includes(j)){if(this.connectionMode!==j)this.#M();return localStorage.setItem(this.#N("modePref"),j),this.connectionMode=j,this.#_=!0,!0}return!1}clearPreferredMode(){localStorage.removeItem(this.#N("modePref")),this.connectionMode=null,this.#_=!1}connectViaSharedWorker(){if(this.#M(),this.sessionStrategy=4,!this.broadcastChannel)this.initConnectionCoordination();try{this.#F=new SharedWorker(this.#B.workerRoute),this.#F.port.start(),this.#F.port.addEventListener("message",(j)=>{this.#K(j.data)}),this.#F.port.postMessage({type:1,connectionId:this.connectionId}),this.connectionMode=1,this.#F.onerror=(j)=>{if(this.#H("SharedWorker error",j),this.#F=null,!this.#_)this.connectDirectly();else this.#H("Not falling back because mode was explicitly set"),this.connectionState=8,this.#J(4,{message:"SharedWorker connection failed"})}}catch(j){if(this.#H("Failed to initialize SharedWorker",j),!this.#_)this.connectDirectly();else this.#H("Not falling back because mode was explicitly set"),this.connectionState=8,this.#J(4,{message:"SharedWorker initialization failed"})}}connectDirectly(){if(this.#M(),this.broadcastChannel)try{this.#x(),this.broadcastChannel.close(),this.broadcastChannel=null,this.#z=null}catch(D){}let j=this.#q(),B=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}${this.#B.wsRoute}?connid=${j}&sessionid=${this.sessionId}`;this.#G=new WebSocket(B),this.connectionMode=4,this.#G.onopen=()=>{this.connectionState=4,this.#$=0,this.#J(2)},this.#G.onclose=()=>{if(this.connectionState=1,this.#J(8),this.#B.reconnectOnDisconnect&&!this.#_)this.#S()},this.#G.onerror=(D)=>{this.#H("Direct WebSocket error",D),this.#J(4,D)},this.#G.onmessage=(D)=>{D.data.split(`
`).filter((G)=>G.trim()).forEach((G)=>{this.#J(1,G)})}}#M(){if(this.connectionState=1,this.#F){try{if(this.#F.port.postMessage({type:2}),this.#F.port.close(),typeof this.#F.terminate==="function")this.#F.terminate()}catch(j){}this.#F=null}if(this.#G){try{this.#G.close()}catch(j){}this.#G=null}if(this.#C)clearTimeout(this.#C),this.#C=null;if(this.broadcastChannel)try{if(this.#D)this.broadcastChannel.postMessage({type:256,id:this.#j,timestamp:Date.now()});this.broadcastChannel.close(),this.broadcastChannel=null}catch(j){}}#p(){if(this.#h)window.removeEventListener("message",this.#h),this.#h=null}send(j){if(typeof j!=="string")j=JSON.stringify(j);if(this.broadcastChannel&&!this.#D){if(!this.#Q)this.#Q=new Map;let z=j,B=Date.now();if(this.#Q.has(z)){let F=this.#Q.get(z);if(B-F.timestamp<1000)return!0}let D=`${this.#j}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;return this.#Q.set(z,{requestId:D,timestamp:B}),setTimeout(()=>{if(this.#Q)this.#Q.delete(z)},5000),this.broadcastChannel.postMessage({type:1,requestId:D,senderId:this.#j,id:this.#j,message:j,timestamp:B}),!0}if(this.connectionState!==4)return this.#H("Cannot send message, not connected"),!1;switch(this.connectionMode){case 1:this.#F.port.postMessage({type:4,data:j});break;case 4:if(this.#G&&this.#G.readyState===WebSocket.OPEN)this.#G.send(j);else return!1;break;default:return!1}return!0}#K(j){switch(j.type){case 8:this.connectionState=4,this.#J(2);break;case 16:if(this.connectionState=1,this.#J(8),this.#B.reconnectOnDisconnect)this.#F.port.postMessage({type:128,connectionId:this.connectionId});break;case 32:if(this.#J(1,j.data),this.broadcastChannel&&this.#D)this.broadcastChannel.postMessage({type:4,id:this.#j,message:j.data,timestamp:Date.now()});break;case 64:this.#H("WebSocket error via SharedWorker",j.error),this.#J(4,j.error);break;default:this.#H("Unknown message from SharedWorker",j)}}#T(j){try{if(!j||!j.type)return;if([1,2].includes(j.type)&&j.senderId===this.#j)return;switch(j.type){case 8:case 16:if(this.#z&&j.id!==this.#j){let z=this.#z.has(j.id);if(this.#z.set(j.id,{id:j.id,isPrimary:j.isPrimary,lastSeen:Date.now()}),!z)this.#L()}break;case 32:if(this.#j>j.id)this.broadcastChannel.postMessage({type:64,id:this.#j,timestamp:Date.now()}),setTimeout(()=>this.#W(),100);break;case 64:if(this.#V)clearTimeout(this.#V),this.#V=null;break;case 128:if(j.id!==this.#j)this.#m();break;case 256:if(j.id!==this.#j)setTimeout(()=>this.#W(),100+Math.random()*400);break;case 4:if(j.id!==this.#j){if(!this.#D)this.#J(1,j.message)}break;case 1:if(this.#D&&j.id!==this.#j&&j.senderId!==this.#j){let z=j.requestId;if(!this.#X)this.#X=new Set;if(this.#X.has(z)){this.broadcastChannel.postMessage({type:2,requestId:j.requestId,targetId:j.senderId,senderId:this.#j,success:!1,duplicate:!0,timestamp:Date.now(),id:this.#j});return}this.#X.add(z),setTimeout(()=>{if(this.#X)this.#X.delete(z)},1e4);let B=!1;if(this.connectionState!==4){this.#H("Cannot forward message, primary not connected"),this.broadcastChannel.postMessage({type:2,requestId:j.requestId,targetId:j.senderId,senderId:this.#j,success:!1,error:"not_connected",timestamp:Date.now(),id:this.#j});return}switch(this.connectionMode){case 1:if(this.#F)this.#F.port.postMessage({type:4,data:j.message}),B=!0;break;case 4:if(this.#G&&this.#G.readyState===WebSocket.OPEN)this.#G.send(j.message),B=!0;break}this.broadcastChannel.postMessage({type:2,requestId:j.requestId,targetId:j.senderId,senderId:this.#j,success:B,timestamp:Date.now(),id:this.#j})}break;case 2:if(!this.#D&&j.targetId===this.#j){if(j.duplicate);else if(j.error==="not_connected");}break;case 512:if(this.#z&&j.id!==this.#j&&j.tabs){let z=!1;if(j.tabs.forEach((B)=>{if(B.id!==this.#j){let D=this.#z.has(B.id),F=D?this.#z.get(B.id):null;if(!D||F&&F.isPrimary!==B.isPrimary)this.#z.set(B.id,B),z=!0}}),z)this.#f(8,Array.from(this.#z.values()))}break;case 1024:if(this.#B.sessionStrategy===2&&j.id!==this.#j)this.sessionData=j.sessionData;break;default:this.#H(`Unknown coordination message type: ${j.type}`,j);break}}catch(z){this.#H("Error handling coordination message",z)}}#S(){if(this.#$>=this.#B.maxReconnectAttempts){this.#H("Maximum reconnection attempts reached");return}let j=Math.min(1000*Math.pow(2,this.#$),30000);this.#$++,setTimeout(()=>{if(this.connectionState===1)this.connectDirectly()},j)}on(j,z){if(this.#A[j])this.#A[j].push(z);return this}#J(j,z){if(j===1){let B=typeof z==="string"?z:JSON.stringify(z);if(!this.#O)this.#O=new Map;let D=Date.now(),F=this.#O.get(B);if(F&&D-F<1000)return;if(this.#O.set(B,D),!this.#R)this.#R=setInterval(()=>{let G=Date.now()-5000;if(this.#O)this.#O.forEach((H,N)=>{if(H<G)this.#O.delete(N)})},1e4)}if(this.#A[j])this.#A[j].forEach((B)=>{try{B(z)}catch(D){}})}#N(j){return`${this.#B[j+"StorageKey"]}${this.#B.endpointKey}`}#u(){if(this.#B.sessionStrategy===1)return this.#w();let j=this.#N("sessionId"),z=localStorage.getItem(j);if(!z)z=this.#q(),localStorage.setItem(j,z);return z}#k(){return this.sessionId=this.#q(),localStorage.setItem(this.#N("sessionId"),this.sessionId),this.sessionData={},this.sessionId}#y(){if(this.#B.sessionStrategy===1)return{};let j=this.#N("sessionData"),z=localStorage.getItem(j);return z?JSON.parse(z):{}}#I(){if(this.#B.sessionStrategy===1)return;let j=this.#N("sessionData");if(localStorage.setItem(j,JSON.stringify(this.sessionData)),this.broadcastChannel)this.broadcastChannel.postMessage({type:1024,sessionData:this.sessionData,timestamp:Date.now()})}setSessionValue(j,z){this.sessionData[j]=z,this.#I()}getSessionValue(j){return this.sessionData[j]}deleteSessionValue(j){delete this.sessionData[j],this.#I()}clearSession(){this.sessionData={},this.#k();let j=this.#N("sessionData");localStorage.removeItem(j)}#l(){let j=this.#N("connId"),z=localStorage.getItem(j);if(!z)z=this.#q(),localStorage.setItem(j,z);return z}#v(){return this.connectionId=this.#q(),localStorage.setItem(this.#N("connId"),this.connectionId),this.connectionId}disconnect(j=!1){switch(this.connectionState=1,this.connectionMode){case 1:if(this.#F){try{this.#F.port.postMessage({type:2}),this.#F.port.close()}catch(z){}this.#F=null}break;case 4:if(this.#G){try{this.#G.close()}catch(z){}this.#G=null}break}if(!j&&this.#D&&this.broadcastChannel)this.broadcastChannel.postMessage({type:256,id:this.#j,timestamp:Date.now()});this.#J(8)}resetConnection(){return this.disconnect(),this.clearPreferredMode(),this.connectionId=this.#v(),this.connect()}#H(j,z){if(this.#B.debug)if(z)window.console.log(`[WebSocketManager] ${j}`,z);else window.console.log(`[WebSocketManager] ${j}`)}#i(){try{let j=new SharedWorker(this.#B.workerRoute);j.port.start(),j.port.postMessage({type:256}),setTimeout(()=>{try{j.port.close()}catch(z){}},100)}catch(j){}try{let z=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}${this.#B.wsRoute}?connid=${this.connectionId}&cleanup=1`,B=new WebSocket(z);B.onopen=()=>{B.send(JSON.stringify({type:1,previousMode:1,newMode:this.connectionMode})),setTimeout(()=>B.close(),50)}}catch(j){}}initConnectionCoordination(){if(typeof BroadcastChannel>"u")return!1;try{return this.broadcastChannel=new BroadcastChannel(this.#B.coordinationChannel),this.broadcastChannel.onmessage=(j)=>{if(!this.#Y)this.#Y=new Map;let z=JSON.stringify(j.data),B=Date.now(),D=this.#Y.get(z);if(D&&B-D<100)return;if(this.#Y.set(z,B),!this.#E)this.#E=setInterval(()=>{let F=Date.now()-1000;this.#Y.forEach((G,H)=>{if(G<F)this.#Y.delete(H)})},5000);this.#T(j.data)},this.#c(),this.#f(1),!0}catch(j){return this.#H("Error initializing coordination",j),!1}}#c(){this.#x(),this.#U(),this.#P=setInterval(()=>{this.#g()},this.#B.coordinationHeartbeat),this.#W(),this.#z=new Map,this.#z.set(this.#j,{id:this.#j,isPrimary:this.#D,lastSeen:Date.now()}),setInterval(()=>{this.#b()},this.#B.coordinationHeartbeat*2),document.addEventListener("visibilitychange",()=>{if(document.visibilityState==="visible"){if(this.#D)this.#D=!1;this.#U(),this.#W()}}),window.addEventListener("beforeunload",()=>{if(this.#D)this.broadcastChannel.postMessage({type:256,id:this.#j,timestamp:Date.now()})})}#x(){if(this.#P)clearInterval(this.#P),this.#P=null;if(this.#V)clearTimeout(this.#V),this.#V=null}#U(){if(!this.broadcastChannel)return;if(this.broadcastChannel.postMessage({type:8,id:this.#j,timestamp:Date.now(),isPrimary:this.#D,connectionState:this.connectionState}),this.#z)this.#z.set(this.#j,{id:this.#j,isPrimary:this.#D,lastSeen:Date.now()}),this.#L()}#b(){if(!this.#z)return;let z=Date.now()-this.#B.assumeDisconnectedAfter*2,B=!1;if(this.#z.forEach((D,F)=>{if(D.lastSeen<z)this.#z.delete(F),B=!0}),B)this.#L()}#L(){if(!this.#z)return;let j=Array.from(this.#z.values());if(this.#f(8,j),this.broadcastChannel)this.broadcastChannel.postMessage({type:512,id:this.#j,timestamp:Date.now(),tabs:j})}#g(){if(!this.broadcastChannel)return;this.broadcastChannel.postMessage({type:16,id:this.#j,timestamp:Date.now(),isPrimary:this.#D,connectionState:this.connectionState})}#W(){if(!this.broadcastChannel)return;this.broadcastChannel.postMessage({type:32,id:this.#j,timestamp:Date.now()}),this.#V=setTimeout(()=>{this.#r()},500)}#r(){if(this.#D)return;if(this.#D=!0,this.broadcastChannel.postMessage({type:128,id:this.#j,timestamp:Date.now()}),this.connectionState!==4)this.connect();if(this.#z)this.#z.set(this.#j,{id:this.#j,isPrimary:!0,lastSeen:Date.now()}),this.#L();this.#f(2)}#m(){if(!this.#D)return;if(this.#D=!1,this.connectionState===4)this.disconnect(!0);if(this.#z)this.#z.set(this.#j,{id:this.#j,isPrimary:!1,lastSeen:Date.now()}),this.#L();this.#f(4)}onCoordinationEvent(j,z){if(!this.#Z[j])this.#Z[j]=[];return this.#Z[j].push(z),this}#f(j,z){if(this.#Z[j])this.#Z[j].forEach((B)=>{try{B(z)}catch(D){}})}#w(){return Date.now().toString()+Math.random().toString(36).substring(2,9)}#q(){return Date.now().toString()+Math.random().toString(36).substring(2,9)}dispose(){if(this.disconnect(),this.#R)clearInterval(this.#R),this.#R=null;if(this.#E)clearInterval(this.#E),this.#E=null;if(this.#O)this.#O.clear();if(this.#X)this.#X.clear();if(this.#Y)this.#Y.clear();if(this.#Q)this.#Q.clear();if(this.broadcastChannel){if(this.#x(),this.#D)this.broadcastChannel.postMessage({type:256,id:this.#j,timestamp:Date.now()});this.broadcastChannel.close(),this.broadcastChannel=null}}getKnownTabs(){return this.#z?Array.from(this.#z.values()):[]}isPrimary(){return this.#D}}async function C(j={}){return new Promise((z)=>{let B=()=>{let D=new J(j);if(D.connectionMode===1||j.enableCoordination===!0){if(D.initConnectionCoordination)D.initConnectionCoordination()}z(D)};if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",B);else B()})}export{C as createWebSocketManager,J as WebSocketManager,X as STATE_ERROR,O as STATE_DISCONNECTED,Q as STATE_CONNECTING,V as STATE_CONNECTED,A as SESSION_SHARED_CONNECTION,$ as SESSION_SHARED,_ as SESSION_ISOLATED,Y as MODE_WORKER,Z as MODE_DIRECT,R as EVENT_OPEN,P as EVENT_MESSAGE,E as EVENT_ERROR,L as EVENT_CLOSE,h as COORD_CB_TABS_UPDATED,f as COORD_CB_ENABLED,W as COORD_CB_BECAME_SECONDARY,q as COORD_CB_BECAME_PRIMARY};
